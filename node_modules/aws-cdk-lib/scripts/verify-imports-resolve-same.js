"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.STANDARD_COMPILER_OPTIONS = exports.withTemporaryDirectory = void 0;
/* eslint-disable no-console */
/**
 * Verify that the two styles of imports we support:
 *
 *    import { aws_ec2 } from 'aws-cdk-lib';
 *    import * as aws_ec2 from 'aws-cdk-lib/aws-ec2';
 *
 * Resolve to the same source file when analyzed using the TypeScript compiler.
 *
 * This is necessary for Rosetta's analysis and translation of examples: we need
 * to know what submodule we're importing here, and we need to be able to deal
 * with both styles since both are used interchangeably.
 */
const os = require("os");
const path = require("path");
const fs = require("fs-extra");
// eslint-disable-next-line import/no-extraneous-dependencies
const ts = require("typescript");
async function main() {
    // First make a tempdir and symlink `aws-cdk-lib` into it so we can refer to it
    // as if it was an installed module.
    await withTemporaryDirectory(async (tmpDir) => {
        await fs.mkdirp(path.join(tmpDir, 'node_modules'));
        await fs.symlink(path.resolve(__dirname, '..'), path.join(tmpDir, 'node_modules', 'aws-cdk-lib'));
        const import1 = 'import { aws_ec2 } from "aws-cdk-lib";';
        const import2 = 'import * as aws_ec2 from "aws-cdk-lib/aws-ec2";';
        const src1 = await compileAndResolve(path.join(tmpDir, 'program1.ts'), import1, 'aws_ec2');
        const src2 = await compileAndResolve(path.join(tmpDir, 'program2.ts'), import2, 'aws_ec2');
        if (src1 !== src2) {
            console.error('Import mismatch!');
            console.error('\n    ', import1, '\n');
            console.error('resolves to', src1);
            console.error('\n    ', import2, '\n');
            console.error('resolves to', src2);
            process.exitCode = 1;
        }
    });
}
async function compileAndResolve(fileName, contents, symbolName) {
    var _a;
    await fs.writeFile(fileName, contents + `\n\nconsole.log(${symbolName});`, { encoding: 'utf-8' });
    const program = ts.createProgram({ rootNames: [fileName], options: exports.STANDARD_COMPILER_OPTIONS });
    const sourceFile = program.getSourceFile(fileName);
    if (!sourceFile) {
        throw new Error(`Could not find sourcefile back: ${fileName}`);
    }
    const diags = [
        ...program.getGlobalDiagnostics(),
        ...program.getDeclarationDiagnostics(sourceFile),
        ...program.getSyntacticDiagnostics(sourceFile),
        ...program.getSemanticDiagnostics(sourceFile),
    ];
    if (diags.length > 0) {
        console.error(ts.formatDiagnostics(diags, {
            getNewLine: () => '\n',
            getCurrentDirectory: () => path.dirname(fileName),
            getCanonicalFileName: (f) => path.resolve(f),
        }));
        throw new Error('Compilation failed');
    }
    // Find the 'console.log()' back and resolve the symbol inside
    const logStmt = assertNode(sourceFile.statements[1], ts.isExpressionStatement);
    const logCall = assertNode(logStmt.expression, ts.isCallExpression);
    const ident = assertNode(logCall.arguments[0], ts.isIdentifier);
    let sym = program.getTypeChecker().getSymbolAtLocation(ident);
    // Resolve alias if applicable
    // eslint-disable-next-line no-bitwise
    while (sym && ((sym.flags & ts.SymbolFlags.Alias) !== 0)) {
        sym = program.getTypeChecker().getAliasedSymbol(sym);
    }
    if (!sym) {
        throw new Error(`Could not resolve: ${symbolName} in '${contents}'`);
    }
    // Return the filename
    const srcFile = (_a = sym.declarations) === null || _a === void 0 ? void 0 : _a[0].getSourceFile().fileName.replace(/.ts|.js|.d.ts/, '');
    if (!srcFile) {
        console.log(sym);
        throw new Error(`Symbol ${symbolName} in '${contents}' does not resolve to a source location`);
    }
    return srcFile;
}
async function withTemporaryDirectory(callback) {
    const tmpdir = await fs.mkdtemp(path.join(os.tmpdir(), path.basename(__filename)));
    try {
        return await callback(tmpdir);
    }
    finally {
        await fs.remove(tmpdir);
    }
}
exports.withTemporaryDirectory = withTemporaryDirectory;
function assertNode(x, assert) {
    if (!assert(x)) {
        throw new Error(`Not the right type of node, expecting ${assert.name}, got ${ts.SyntaxKind[x.kind]}`);
    }
    return x;
}
exports.STANDARD_COMPILER_OPTIONS = {
    alwaysStrict: true,
    charset: 'utf8',
    declaration: true,
    experimentalDecorators: true,
    inlineSourceMap: true,
    inlineSources: true,
    lib: ['lib.es2016.d.ts', 'lib.es2017.object.d.ts', 'lib.es2017.string.d.ts'],
    module: ts.ModuleKind.CommonJS,
    noEmitOnError: true,
    noFallthroughCasesInSwitch: true,
    noImplicitAny: true,
    noImplicitReturns: true,
    noImplicitThis: true,
    noUnusedLocals: false,
    noUnusedParameters: false,
    resolveJsonModule: true,
    strict: true,
    strictNullChecks: true,
    strictPropertyInitialization: true,
    stripInternal: true,
    target: ts.ScriptTarget.ES2019,
    // Incremental builds
    incremental: true,
    tsBuildInfoFile: '.tsbuildinfo',
};
main().catch((e) => {
    // eslint-disable-next-line no-console
    console.error(e);
    process.exitCode = 1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyaWZ5LWltcG9ydHMtcmVzb2x2ZS1zYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmVyaWZ5LWltcG9ydHMtcmVzb2x2ZS1zYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUErQjtBQUMvQjs7Ozs7Ozs7Ozs7R0FXRztBQUNILHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsK0JBQStCO0FBRS9CLDZEQUE2RDtBQUM3RCxpQ0FBaUM7QUFFakMsS0FBSyxVQUFVLElBQUk7SUFDakIsK0VBQStFO0lBQy9FLG9DQUFvQztJQUNwQyxNQUFNLHNCQUFzQixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM1QyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUNuRCxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFFbEcsTUFBTSxPQUFPLEdBQUcsd0NBQXdDLENBQUM7UUFDekQsTUFBTSxPQUFPLEdBQUcsaURBQWlELENBQUM7UUFFbEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDM0YsTUFBTSxJQUFJLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFM0YsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMs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QUFBLHlCQUF5QixHQUF1QjtJQUMzRCxZQUFZLEVBQUUsSUFBSTtJQUNsQixPQUFPLEVBQUUsTUFBTTtJQUNmLFdBQVcsRUFBRSxJQUFJO0lBQ2pCLHNCQUFzQixFQUFFLElBQUk7SUFDNUIsZUFBZSxFQUFFLElBQUk7SUFDckIsYUFBYSxFQUFFLElBQUk7SUFDbkIsR0FBRyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsd0JBQXdCLEVBQUUsd0JBQXdCLENBQUM7SUFDNUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUTtJQUM5QixhQUFhLEVBQUUsSUFBSTtJQUNuQiwwQkFBMEIsRUFBRSxJQUFJO0lBQ2hDLGFBQWEsRUFBRSxJQUFJO0lBQ25CLGlCQUFpQixFQUFFLElBQUk7SUFDdkIsY0FBYyxFQUFFLElBQUk7SUFDcEIsY0FBYyxFQUFFLEtBQUs7SUFDckIsa0JBQWtCLEVBQUUsS0FBSztJQUN6QixpQkFBaUIsRUFBRSxJQUFJO0lBQ3ZCLE1BQU0sRUFBRSxJQUFJO0lBQ1osZ0JBQWdCLEVBQUUsSUFBSTtJQUN0Qiw0QkFBNEIsRUFBRSxJQUFJO0lBQ2xDLGFBQWEsRUFBRSxJQUFJO0lBQ25CLE1BQU0sRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU07SUFDOUIscUJBQXFCO0lBQ3JCLFdBQVcsRUFBRSxJQUFJO0lBQ2pCLGVBQWUsRUFBRSxjQUFjO0NBQ2hDLENBQUM7QUFFRixJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtJQUNqQixzQ0FBc0M7SUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixPQUFPLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbi8qKlxuICogVmVyaWZ5IHRoYXQgdGhlIHR3byBzdHlsZXMgb2YgaW1wb3J0cyB3ZSBzdXBwb3J0OlxuICpcbiAqICAgIGltcG9ydCB7IGF3c19lYzIgfSBmcm9tICdhd3MtY2RrLWxpYic7XG4gKiAgICBpbXBvcnQgKiBhcyBhd3NfZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuICpcbiAqIFJlc29sdmUgdG8gdGhlIHNhbWUgc291cmNlIGZpbGUgd2hlbiBhbmFseXplZCB1c2luZyB0aGUgVHlwZVNjcmlwdCBjb21waWxlci5cbiAqXG4gKiBUaGlzIGlzIG5lY2Vzc2FyeSBmb3IgUm9zZXR0YSdzIGFuYWx5c2lzIGFuZCB0cmFuc2xhdGlvbiBvZiBleGFtcGxlczogd2UgbmVlZFxuICogdG8ga25vdyB3aGF0IHN1Ym1vZHVsZSB3ZSdyZSBpbXBvcnRpbmcgaGVyZSwgYW5kIHdlIG5lZWQgdG8gYmUgYWJsZSB0byBkZWFsXG4gKiB3aXRoIGJvdGggc3R5bGVzIHNpbmNlIGJvdGggYXJlIHVzZWQgaW50ZXJjaGFuZ2VhYmx5LlxuICovXG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgaW1wb3J0L25vLWV4dHJhbmVvdXMtZGVwZW5kZW5jaWVzXG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgLy8gRmlyc3QgbWFrZSBhIHRlbXBkaXIgYW5kIHN5bWxpbmsgYGF3cy1jZGstbGliYCBpbnRvIGl0IHNvIHdlIGNhbiByZWZlciB0byBpdFxuICAvLyBhcyBpZiBpdCB3YXMgYW4gaW5zdGFsbGVkIG1vZHVsZS5cbiAgYXdhaXQgd2l0aFRlbXBvcmFyeURpcmVjdG9yeShhc3luYyAodG1wRGlyKSA9PiB7XG4gICAgYXdhaXQgZnMubWtkaXJwKHBhdGguam9pbih0bXBEaXIsICdub2RlX21vZHVsZXMnKSk7XG4gICAgYXdhaXQgZnMuc3ltbGluayhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nKSwgcGF0aC5qb2luKHRtcERpciwgJ25vZGVfbW9kdWxlcycsICdhd3MtY2RrLWxpYicpKTtcblxuICAgIGNvbnN0IGltcG9ydDEgPSAnaW1wb3J0IHsgYXdzX2VjMiB9IGZyb20gXCJhd3MtY2RrLWxpYlwiOyc7XG4gICAgY29uc3QgaW1wb3J0MiA9ICdpbXBvcnQgKiBhcyBhd3NfZWMyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWMyXCI7JztcblxuICAgIGNvbnN0IHNyYzEgPSBhd2FpdCBjb21waWxlQW5kUmVzb2x2ZShwYXRoLmpvaW4odG1wRGlyLCAncHJvZ3JhbTEudHMnKSwgaW1wb3J0MSwgJ2F3c19lYzInKTtcbiAgICBjb25zdCBzcmMyID0gYXdhaXQgY29tcGlsZUFuZFJlc29sdmUocGF0aC5qb2luKHRtcERpciwgJ3Byb2dyYW0yLnRzJyksIGltcG9ydDIsICdhd3NfZWMyJyk7XG5cbiAgICBpZiAoc3JjMSAhPT0gc3JjMikge1xuICAgICAgY29uc29sZS5lcnJvcignSW1wb3J0IG1pc21hdGNoIScpO1xuICAgICAgY29uc29sZS5lcnJvcignXFxuICAgICcsIGltcG9ydDEsICdcXG4nKTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ3Jlc29sdmVzIHRvJywgc3JjMSk7XG4gICAgICBjb25zb2xlLmVycm9yKCdcXG4gICAgJywgaW1wb3J0MiwgJ1xcbicpO1xuICAgICAgY29uc29sZS5lcnJvcigncmVzb2x2ZXMgdG8nLCBzcmMyKTtcbiAgICAgIHByb2Nlc3MuZXhpdENvZGUgPSAxO1xuICAgIH1cbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbXBpbGVBbmRSZXNvbHZlKGZpbGVOYW1lOiBzdHJpbmcsIGNvbnRlbnRzOiBzdHJpbmcsIHN5bWJvbE5hbWU6IHN0cmluZykge1xuICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZU5hbWUsIGNvbnRlbnRzICsgYFxcblxcbmNvbnNvbGUubG9nKCR7c3ltYm9sTmFtZX0pO2AsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSk7XG4gIGNvbnN0IHByb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKHsgcm9vdE5hbWVzOiBbZmlsZU5hbWVdLCBvcHRpb25zOiBTVEFOREFSRF9DT01QSUxFUl9PUFRJT05TIH0pO1xuXG4gIGNvbnN0IHNvdXJjZUZpbGUgPSBwcm9ncmFtLmdldFNvdXJjZUZpbGUoZmlsZU5hbWUpO1xuICBpZiAoIXNvdXJjZUZpbGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHNvdXJjZWZpbGUgYmFjazogJHtmaWxlTmFtZX1gKTtcbiAgfVxuXG4gIGNvbnN0IGRpYWdzID0gW1xuICAgIC4uLnByb2dyYW0uZ2V0R2xvYmFsRGlhZ25vc3RpY3MoKSxcbiAgICAuLi5wcm9ncmFtLmdldERlY2xhcmF0aW9uRGlhZ25vc3RpY3Moc291cmNlRmlsZSksXG4gICAgLi4ucHJvZ3JhbS5nZXRTeW50YWN0aWNEaWFnbm9zdGljcyhzb3VyY2VGaWxlKSxcbiAgICAuLi5wcm9ncmFtLmdldFNlbWFudGljRGlhZ25vc3RpY3Moc291cmNlRmlsZSksXG4gIF07XG4gIGlmIChkaWFncy5sZW5ndGggPiAwKSB7XG4gICAgY29uc29sZS5lcnJvcih0cy5mb3JtYXREaWFnbm9zdGljcyhkaWFncywge1xuICAgICAgZ2V0TmV3TGluZTogKCkgPT4gJ1xcbicsXG4gICAgICBnZXRDdXJyZW50RGlyZWN0b3J5OiAoKSA9PiBwYXRoLmRpcm5hbWUoZmlsZU5hbWUpLFxuICAgICAgZ2V0Q2Fub25pY2FsRmlsZU5hbWU6IChmKSA9PiBwYXRoLnJlc29sdmUoZiksXG4gICAgfSkpO1xuICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsYXRpb24gZmFpbGVkJyk7XG4gIH1cblxuICAvLyBGaW5kIHRoZSAnY29uc29sZS5sb2coKScgYmFjayBhbmQgcmVzb2x2ZSB0aGUgc3ltYm9sIGluc2lkZVxuICBjb25zdCBsb2dTdG10ID0gYXNzZXJ0Tm9kZShzb3VyY2VGaWxlLnN0YXRlbWVudHNbMV0sIHRzLmlzRXhwcmVzc2lvblN0YXRlbWVudCk7XG4gIGNvbnN0IGxvZ0NhbGwgPSBhc3NlcnROb2RlKGxvZ1N0bXQuZXhwcmVzc2lvbiwgdHMuaXNDYWxsRXhwcmVzc2lvbik7XG4gIGNvbnN0IGlkZW50ID0gYXNzZXJ0Tm9kZShsb2dDYWxsLmFyZ3VtZW50c1swXSwgdHMuaXNJZGVudGlmaWVyKTtcblxuICBsZXQgc3ltID0gcHJvZ3JhbS5nZXRUeXBlQ2hlY2tlcigpLmdldFN5bWJvbEF0TG9jYXRpb24oaWRlbnQpO1xuXG4gIC8vIFJlc29sdmUgYWxpYXMgaWYgYXBwbGljYWJsZVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZVxuICB3aGlsZSAoc3ltICYmICgoc3ltLmZsYWdzICYgdHMuU3ltYm9sRmxhZ3MuQWxpYXMpICE9PSAwKSkge1xuICAgIHN5bSA9IHByb2dyYW0uZ2V0VHlwZUNoZWNrZXIoKS5nZXRBbGlhc2VkU3ltYm9sKHN5bSk7XG4gIH1cblxuICBpZiAoIXN5bSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHJlc29sdmU6ICR7c3ltYm9sTmFtZX0gaW4gJyR7Y29udGVudHN9J2ApO1xuICB9XG5cbiAgLy8gUmV0dXJuIHRoZSBmaWxlbmFtZVxuICBjb25zdCBzcmNGaWxlID0gc3ltLmRlY2xhcmF0aW9ucz8uWzBdLmdldFNvdXJjZUZpbGUoKS5maWxlTmFtZS5yZXBsYWNlKC8udHN8LmpzfC5kLnRzLywgJycpO1xuICBpZiAoIXNyY0ZpbGUpIHtcbiAgICBjb25zb2xlLmxvZyhzeW0pO1xuICAgIHRocm93IG5ldyBFcnJvcihgU3ltYm9sICR7c3ltYm9sTmFtZX0gaW4gJyR7Y29udGVudHN9JyBkb2VzIG5vdCByZXNvbHZlIHRvIGEgc291cmNlIGxvY2F0aW9uYCk7XG4gIH1cbiAgcmV0dXJuIHNyY0ZpbGU7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoVGVtcG9yYXJ5RGlyZWN0b3J5PFQ+KGNhbGxiYWNrOiAoZGlyOiBzdHJpbmcpID0+IFByb21pc2U8VD4pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgdG1wZGlyID0gYXdhaXQgZnMubWtkdGVtcChwYXRoLmpvaW4ob3MudG1wZGlyKCksIHBhdGguYmFzZW5hbWUoX19maWxlbmFtZSkpKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgY2FsbGJhY2sodG1wZGlyKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yZW1vdmUodG1wZGlyKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlcnROb2RlPEEgZXh0ZW5kcyB0cy5Ob2RlPih4OiB0cy5Ob2RlLCBhc3NlcnQ6ICh4OiB0cy5Ob2RlKSA9PiB4IGlzIEEpOiBBIHtcbiAgaWYgKCFhc3NlcnQoeCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCB0aGUgcmlnaHQgdHlwZSBvZiBub2RlLCBleHBlY3RpbmcgJHthc3NlcnQubmFtZX0sIGdvdCAke3RzLlN5bnRheEtpbmRbeC5raW5kXX1gKTtcbiAgfVxuICByZXR1cm4geDtcbn1cblxuZXhwb3J0IGNvbnN0IFNUQU5EQVJEX0NPTVBJTEVSX09QVElPTlM6IHRzLkNvbXBpbGVyT3B0aW9ucyA9IHtcbiAgYWx3YXlzU3RyaWN0OiB0cnVlLFxuICBjaGFyc2V0OiAndXRmOCcsXG4gIGRlY2xhcmF0aW9uOiB0cnVlLFxuICBleHBlcmltZW50YWxEZWNvcmF0b3JzOiB0cnVlLFxuICBpbmxpbmVTb3VyY2VNYXA6IHRydWUsXG4gIGlubGluZVNvdXJjZXM6IHRydWUsXG4gIGxpYjogWydsaWIuZXMyMDE2LmQudHMnLCAnbGliLmVzMjAxNy5vYmplY3QuZC50cycsICdsaWIuZXMyMDE3LnN0cmluZy5kLnRzJ10sXG4gIG1vZHVsZTogdHMuTW9kdWxlS2luZC5Db21tb25KUyxcbiAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgbm9GYWxsdGhyb3VnaENhc2VzSW5Td2l0Y2g6IHRydWUsXG4gIG5vSW1wbGljaXRBbnk6IHRydWUsXG4gIG5vSW1wbGljaXRSZXR1cm5zOiB0cnVlLFxuICBub0ltcGxpY2l0VGhpczogdHJ1ZSxcbiAgbm9VbnVzZWRMb2NhbHM6IGZhbHNlLCAvLyBJbXBvcnRhbnQsIGJlY29tZXMgc3VwZXIgYW5ub3lpbmcgd2l0aG91dCB0aGlzXG4gIG5vVW51c2VkUGFyYW1ldGVyczogZmFsc2UsIC8vIEltcG9ydGFudCwgYmVjb21lcyBzdXBlciBhbm5veWluZyB3aXRob3V0IHRoaXNcbiAgcmVzb2x2ZUpzb25Nb2R1bGU6IHRydWUsXG4gIHN0cmljdDogdHJ1ZSxcbiAgc3RyaWN0TnVsbENoZWNrczogdHJ1ZSxcbiAgc3RyaWN0UHJvcGVydHlJbml0aWFsaXphdGlvbjogdHJ1ZSxcbiAgc3RyaXBJbnRlcm5hbDogdHJ1ZSxcbiAgdGFyZ2V0OiB0cy5TY3JpcHRUYXJnZXQuRVMyMDE5LFxuICAvLyBJbmNyZW1lbnRhbCBidWlsZHNcbiAgaW5jcmVtZW50YWw6IHRydWUsXG4gIHRzQnVpbGRJbmZvRmlsZTogJy50c2J1aWxkaW5mbycsXG59O1xuXG5tYWluKCkuY2F0Y2goKGUpID0+IHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0Q29kZSA9IDE7XG59KTtcbiJdfQ==