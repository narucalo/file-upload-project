"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// +------------------------------------------------------------------------------------------------
// | this script is executed post packaging to verify that experimental modules in aws-cdk-lib includes **only**  L1 autogenerated files.
// | The purpose is to avoid publishing L2 of experimental modules with aws-cdk-lib
// |
const child_process_1 = require("child_process");
const console = require("console");
const os = require("os");
const path = require("path");
const fs = require("fs-extra");
async function main(tempDir) {
    var _a;
    console.log('üßê Verifying all experimental modules includes only L1s files...');
    const cwd = process.cwd();
    const awsCdkModulesRepoPath = path.join(findWorkspacePath(), 'packages', '@aws-cdk');
    // eslint-disable-next-line @typescript-eslint/no-require-imports
    const version = require('./../package.json').version;
    const tarFullPath = path.join(cwd, 'dist', 'js', `aws-cdk-lib@${version}.jsii.tgz`);
    const invalidCfnModules = new Map();
    const invalidModules = new Array();
    // install the tarball in a temp directory
    console.log(`installing aws-cdk-lib from dist/js into ${tempDir}`);
    exec('npm', ['install', '--prefix', tempDir, tarFullPath]);
    const installedAwsCdkLibPath = path.join(tempDir, 'node_modules', 'aws-cdk-lib', 'lib');
    for (const module of fs.readdirSync(awsCdkModulesRepoPath)) {
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const pkgJson = require(path.join(awsCdkModulesRepoPath, module, 'package.json'));
        if (pkgJson.stability !== 'experimental') {
            continue;
        }
        if ((_a = pkgJson['cdk-build']) === null || _a === void 0 ? void 0 : _a.cloudformation) {
            // if a cfn module, verify only the allowed files exists
            const files = await listAllFiles(path.join(installedAwsCdkLibPath, module));
            const invalidFiles = new Array();
            files.forEach(file => {
                if (!isAllowedFile(file)) {
                    invalidFiles.push(file);
                }
            });
            if (invalidFiles.length > 0) {
                invalidCfnModules.set(module, invalidFiles);
            }
        }
        else {
            // not a cfn module, verify it was entirely removed
            if (fs.existsSync(path.join(installedAwsCdkLibPath, module))) {
                invalidModules.push(module);
            }
        }
    }
    if (invalidCfnModules.size > 0 || invalidModules.length > 0) {
        if (invalidCfnModules.size > 0) {
            console.log('cfn module with invalid files:');
            for (let [module, files] of invalidCfnModules.entries()) {
                console.log(`${module}:`);
                files.forEach(file => console.log(`\t ${file}`));
            }
        }
        console.log('---------------------------------------------');
        if (invalidModules.length > 0) {
            console.log('non-cfn experimental modules:');
            invalidModules.forEach(m => console.log(`\t ${m}`));
        }
        throw new Error('Verification Error');
    }
}
const tempDir = fs.mkdtempSync(os.tmpdir());
main(tempDir).then(() => {
    fs.removeSync(tempDir);
    console.log('‚úÖ All experimental modules includes only L1s files!');
    process.exit(0);
}, (err) => {
    process.stderr.write(`${err}\n`);
    process.stderr.write(`‚ùå Verification failed, Some experimental modules includes non L1 files, see details above. Inspect working directory: '${tempDir}'`);
    process.exit(1);
});
/**
 * Spawn sync with error handling
 */
function exec(cmd, args) {
    var _a, _b;
    const proc = child_process_1.spawnSync(cmd, args);
    if (proc.error) {
        throw proc.error;
    }
    if (proc.status !== 0) {
        if (proc.stdout || proc.stderr) {
            throw new Error(`${cmd} exited with status ${proc.status}; stdout: ${(_a = proc.stdout) === null || _a === void 0 ? void 0 : _a.toString().trim()}\n\n\nstderr: ${(_b = proc.stderr) === null || _b === void 0 ? void 0 : _b.toString().trim()}`);
        }
        throw new Error(`${cmd} exited with status ${proc.status}`);
    }
    return proc;
}
const GENERATED_SUFFIX_REGEX = new RegExp(/generated\.(js|d\.ts)$/);
const ALLOWED_FILES = ['.jsiirc.json', 'index.ts', 'index.js', 'index.d.ts'];
/**
 * Recursively collect all files in dir
 */
async function listAllFiles(dir) {
    const ret = new Array();
    async function recurse(part) {
        const files = await fs.readdir(part);
        for (const file of files) {
            const fullPath = path.join(part, file);
            if ((await fs.stat(fullPath)).isDirectory()) {
                await recurse(fullPath);
            }
            else {
                ret.push(file);
            }
        }
    }
    await recurse(dir);
    return ret;
}
/**
 * Find the workspace root path. Walk up the directory tree until you find lerna.json
 */
function findWorkspacePath() {
    return _findRootPath(process.cwd());
    function _findRootPath(part) {
        if (part === path.resolve(part, '..')) {
            throw new Error('couldn\'t find a \'lerna.json\' file when walking up the directory tree, are you in a aws-cdk project?');
        }
        if (fs.existsSync(path.resolve(part, 'lerna.json'))) {
            return part;
        }
        return _findRootPath(path.resolve(part, '..'));
    }
}
/**
 * @param file
 * @returns true if the file allowed in an L1 only modules, otherwise false
 */
function isAllowedFile(file) {
    if (GENERATED_SUFFIX_REGEX.test(file)) {
        return true;
    }
    return ALLOWED_FILES.includes(file);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyaWZ5LXN0cmlwcGVkLWV4cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZlcmlmeS1zdHJpcHBlZC1leHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvR0FBb0c7QUFDcEcseUlBQXlJO0FBQ3pJLG1GQUFtRjtBQUNuRixJQUFJO0FBQ0osaURBQTBDO0FBQzFDLG1DQUFtQztBQUNuQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLCtCQUErQjtBQUUvQixLQUFLLFVBQVUsSUFBSSxDQUFDLE9BQWU7O0lBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0VBQWtFLENBQUMsQ0FBQztJQUNoRixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDMUIsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3JGLGlFQUFpRTtJQUNqRSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxPQUFPLENBQUM7SUFDckQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxlQUFlLE9BQU8sV0FBVyxDQUFDLENBQUM7SUFFcEYsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBeUIsQ0FBQztJQUMzRCxNQUFNLGNBQWMsR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO0lBRTNDLDBDQUEwQztJQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBQzNELE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsY0FBYyxF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LENBQUM7SUFDakQsQ0FBQztBQUNILENBQUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFTLGFBQWEsQ0FBQyxJQUFZO0lBQ2pDLElBQUksc0JBQXNCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3JDLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFDRCxPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIHwgdGhpcyBzY3JpcHQgaXMgZXhlY3V0ZWQgcG9zdCBwYWNrYWdpbmcgdG8gdmVyaWZ5IHRoYXQgZXhwZXJpbWVudGFsIG1vZHVsZXMgaW4gYXdzLWNkay1saWIgaW5jbHVkZXMgKipvbmx5KiogIEwxIGF1dG9nZW5lcmF0ZWQgZmlsZXMuXG4vLyB8IFRoZSBwdXJwb3NlIGlzIHRvIGF2b2lkIHB1Ymxpc2hpbmcgTDIgb2YgZXhwZXJpbWVudGFsIG1vZHVsZXMgd2l0aCBhd3MtY2RrLWxpYlxuLy8gfFxuaW1wb3J0IHsgc3Bhd25TeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgKiBhcyBjb25zb2xlIGZyb20gJ2NvbnNvbGUnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcblxuYXN5bmMgZnVuY3Rpb24gbWFpbih0ZW1wRGlyOiBzdHJpbmcpIHtcbiAgY29uc29sZS5sb2coJ/Cfp5AgVmVyaWZ5aW5nIGFsbCBleHBlcmltZW50YWwgbW9kdWxlcyBpbmNsdWRlcyBvbmx5IEwxcyBmaWxlcy4uLicpO1xuICBjb25zdCBjd2QgPSBwcm9jZXNzLmN3ZCgpO1xuICBjb25zdCBhd3NDZGtNb2R1bGVzUmVwb1BhdGggPSBwYXRoLmpvaW4oZmluZFdvcmtzcGFjZVBhdGgoKSwgJ3BhY2thZ2VzJywgJ0Bhd3MtY2RrJyk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzXG4gIGNvbnN0IHZlcnNpb24gPSByZXF1aXJlKCcuLy4uL3BhY2thZ2UuanNvbicpLnZlcnNpb247XG4gIGNvbnN0IHRhckZ1bGxQYXRoID0gcGF0aC5qb2luKGN3ZCwgJ2Rpc3QnLCAnanMnLCBgYXdzLWNkay1saWJAJHt2ZXJzaW9ufS5qc2lpLnRnemApO1xuXG4gIGNvbnN0IGludmFsaWRDZm5Nb2R1bGVzID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PFN0cmluZz4+KCk7XG4gIGNvbnN0IGludmFsaWRNb2R1bGVzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcblxuICAvLyBpbnN0YWxsIHRoZSB0YXJiYWxsIGluIGEgdGVtcCBkaXJlY3RvcnlcbiAgY29uc29sZS5sb2coYGluc3RhbGxpbmcgYXdzLWNkay1saWIgZnJvbSBkaXN0L2pzIGludG8gJHt0ZW1wRGlyfWApO1xuICBleGVjKCducG0nLCBbJ2luc3RhbGwnLCAnLS1wcmVmaXgnLCB0ZW1wRGlyLCB0YXJGdWxsUGF0aF0pO1xuICBjb25zdCBpbnN0YWxsZWRBd3NDZGtMaWJQYXRoID0gcGF0aC5qb2luKHRlbXBEaXIsICdub2RlX21vZHVsZXMnLCAnYXdzLWNkay1saWInLCAnbGliJyk7XG5cbiAgZm9yIChjb25zdCBtb2R1bGUgb2YgZnMucmVhZGRpclN5bmMoYXdzQ2RrTW9kdWxlc1JlcG9QYXRoKSkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzXG4gICAgY29uc3QgcGtnSnNvbiA9IHJlcXVpcmUocGF0aC5qb2luKGF3c0Nka01vZHVsZXNSZXBvUGF0aCwgbW9kdWxlLCAncGFja2FnZS5qc29uJykpO1xuICAgIGlmIChwa2dKc29uLnN0YWJpbGl0eSAhPT0gJ2V4cGVyaW1lbnRhbCcpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBpZiAocGtnSnNvblsnY2RrLWJ1aWxkJ10/LmNsb3VkZm9ybWF0aW9uKSB7XG4gICAgICAvLyBpZiBhIGNmbiBtb2R1bGUsIHZlcmlmeSBvbmx5IHRoZSBhbGxvd2VkIGZpbGVzIGV4aXN0c1xuICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBsaXN0QWxsRmlsZXMocGF0aC5qb2luKGluc3RhbGxlZEF3c0Nka0xpYlBhdGgsIG1vZHVsZSkpO1xuICAgICAgY29uc3QgaW52YWxpZEZpbGVzID0gbmV3IEFycmF5KCk7XG4gICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICBpZiAoIWlzQWxsb3dlZEZpbGUoZmlsZSkpIHtcbiAgICAgICAgICBpbnZhbGlkRmlsZXMucHVzaChmaWxlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBpZiAoaW52YWxpZEZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaW52YWxpZENmbk1vZHVsZXMuc2V0KG1vZHVsZSwgaW52YWxpZEZpbGVzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm90IGEgY2ZuIG1vZHVsZSwgdmVyaWZ5IGl0IHdhcyBlbnRpcmVseSByZW1vdmVkXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oaW5zdGFsbGVkQXdzQ2RrTGliUGF0aCwgbW9kdWxlKSkpIHtcbiAgICAgICAgaW52YWxpZE1vZHVsZXMucHVzaChtb2R1bGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChpbnZhbGlkQ2ZuTW9kdWxlcy5zaXplID4gMCB8fCBpbnZhbGlkTW9kdWxlcy5sZW5ndGggPiAwKSB7XG4gICAgaWYgKGludmFsaWRDZm5Nb2R1bGVzLnNpemUgPiAwICkge1xuICAgICAgY29uc29sZS5sb2coJ2NmbiBtb2R1bGUgd2l0aCBpbnZhbGlkIGZpbGVzOicpO1xuICAgICAgZm9yIChsZXQgW21vZHVsZSwgZmlsZXNdIG9mIGludmFsaWRDZm5Nb2R1bGVzLmVudHJpZXMoKSkge1xuICAgICAgICBjb25zb2xlLmxvZyhgJHttb2R1bGV9OmApO1xuICAgICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4gY29uc29sZS5sb2coYFxcdCAke2ZpbGV9YCkpO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zb2xlLmxvZygnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG4gICAgaWYgKGludmFsaWRNb2R1bGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCdub24tY2ZuIGV4cGVyaW1lbnRhbCBtb2R1bGVzOicpO1xuICAgICAgaW52YWxpZE1vZHVsZXMuZm9yRWFjaChtID0+IGNvbnNvbGUubG9nKGBcXHQgJHttfWApKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKCdWZXJpZmljYXRpb24gRXJyb3InKTtcbiAgfVxufVxuXG5jb25zdCB0ZW1wRGlyID0gZnMubWtkdGVtcFN5bmMob3MudG1wZGlyKCkpO1xuXG5tYWluKHRlbXBEaXIpLnRoZW4oXG4gICgpID0+IHtcbiAgICBmcy5yZW1vdmVTeW5jKHRlbXBEaXIpO1xuICAgIGNvbnNvbGUubG9nKCfinIUgQWxsIGV4cGVyaW1lbnRhbCBtb2R1bGVzIGluY2x1ZGVzIG9ubHkgTDFzIGZpbGVzIScpO1xuICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgfSxcbiAgKGVycikgPT4ge1xuICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKGAke2Vycn1cXG5gKTtcbiAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShg4p2MIFZlcmlmaWNhdGlvbiBmYWlsZWQsIFNvbWUgZXhwZXJpbWVudGFsIG1vZHVsZXMgaW5jbHVkZXMgbm9uIEwxIGZpbGVzLCBzZWUgZGV0YWlscyBhYm92ZS4gSW5zcGVjdCB3b3JraW5nIGRpcmVjdG9yeTogJyR7dGVtcERpcn0nYCk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9LFxuKTtcblxuXG4vKipcbiAqIFNwYXduIHN5bmMgd2l0aCBlcnJvciBoYW5kbGluZ1xuICovXG5mdW5jdGlvbiBleGVjKGNtZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSkge1xuICBjb25zdCBwcm9jID0gc3Bhd25TeW5jKGNtZCwgYXJncyk7XG5cbiAgaWYgKHByb2MuZXJyb3IpIHtcbiAgICB0aHJvdyBwcm9jLmVycm9yO1xuICB9XG5cbiAgaWYgKHByb2Muc3RhdHVzICE9PSAwKSB7XG4gICAgaWYgKHByb2Muc3Rkb3V0IHx8IHByb2Muc3RkZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7Y21kfSBleGl0ZWQgd2l0aCBzdGF0dXMgJHtwcm9jLnN0YXR1c307IHN0ZG91dDogJHtwcm9jLnN0ZG91dD8udG9TdHJpbmcoKS50cmltKCl9XFxuXFxuXFxuc3RkZXJyOiAke3Byb2Muc3RkZXJyPy50b1N0cmluZygpLnRyaW0oKX1gKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke2NtZH0gZXhpdGVkIHdpdGggc3RhdHVzICR7cHJvYy5zdGF0dXN9YCk7XG4gIH1cblxuICByZXR1cm4gcHJvYztcbn1cblxuY29uc3QgR0VORVJBVEVEX1NVRkZJWF9SRUdFWCA9IG5ldyBSZWdFeHAoL2dlbmVyYXRlZFxcLihqc3xkXFwudHMpJC8pO1xuY29uc3QgQUxMT1dFRF9GSUxFUyA9IFsnLmpzaWlyYy5qc29uJywgJ2luZGV4LnRzJywgJ2luZGV4LmpzJywgJ2luZGV4LmQudHMnXTtcblxuLyoqXG4gKiBSZWN1cnNpdmVseSBjb2xsZWN0IGFsbCBmaWxlcyBpbiBkaXJcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbGlzdEFsbEZpbGVzKGRpcjogc3RyaW5nKSB7XG4gIGNvbnN0IHJldCA9IG5ldyBBcnJheSgpO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIHJlY3Vyc2UocGFydDogc3RyaW5nKSB7XG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBmcy5yZWFkZGlyKHBhcnQpO1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4ocGFydCwgZmlsZSk7XG4gICAgICBpZiAoKGF3YWl0IGZzLnN0YXQoZnVsbFBhdGgpKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGF3YWl0IHJlY3Vyc2UoZnVsbFBhdGgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0LnB1c2goZmlsZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGF3YWl0IHJlY3Vyc2UoZGlyKTtcbiAgcmV0dXJuIHJldDtcbn1cblxuLyoqXG4gKiBGaW5kIHRoZSB3b3Jrc3BhY2Ugcm9vdCBwYXRoLiBXYWxrIHVwIHRoZSBkaXJlY3RvcnkgdHJlZSB1bnRpbCB5b3UgZmluZCBsZXJuYS5qc29uXG4gKi9cbmZ1bmN0aW9uIGZpbmRXb3Jrc3BhY2VQYXRoKCkge1xuXG4gIHJldHVybiBfZmluZFJvb3RQYXRoKHByb2Nlc3MuY3dkKCkpO1xuXG4gIGZ1bmN0aW9uIF9maW5kUm9vdFBhdGgocGFydDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAocGFydCA9PT0gcGF0aC5yZXNvbHZlKHBhcnQsICcuLicpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkblxcJ3QgZmluZCBhIFxcJ2xlcm5hLmpzb25cXCcgZmlsZSB3aGVuIHdhbGtpbmcgdXAgdGhlIGRpcmVjdG9yeSB0cmVlLCBhcmUgeW91IGluIGEgYXdzLWNkayBwcm9qZWN0PycpO1xuICAgIH1cblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGgucmVzb2x2ZShwYXJ0LCAnbGVybmEuanNvbicpKSkge1xuICAgICAgcmV0dXJuIHBhcnQ7XG4gICAgfVxuICAgIHJldHVybiBfZmluZFJvb3RQYXRoKHBhdGgucmVzb2x2ZShwYXJ0LCAnLi4nKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0gZmlsZVxuICogQHJldHVybnMgdHJ1ZSBpZiB0aGUgZmlsZSBhbGxvd2VkIGluIGFuIEwxIG9ubHkgbW9kdWxlcywgb3RoZXJ3aXNlIGZhbHNlXG4gKi9cbmZ1bmN0aW9uIGlzQWxsb3dlZEZpbGUoZmlsZTogc3RyaW5nKSB7XG4gIGlmIChHRU5FUkFURURfU1VGRklYX1JFR0VYLnRlc3QoZmlsZSkpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gQUxMT1dFRF9GSUxFUy5pbmNsdWRlcyhmaWxlKTtcbn0iXX0=