"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CodePipelineSource = void 0;
const jsiiDeprecationWarnings = require("../../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const cp_actions = require("../../../aws-codepipeline-actions");
const core_1 = require("../../../core");
const constructs_1 = require("constructs");
const blueprint_1 = require("../blueprint");
/**
 * CodePipeline source steps.
 *
 * This class contains a number of factory methods for the different types
 * of sources that CodePipeline supports.
 *
 * @stability stable
 */
class CodePipelineSource extends blueprint_1.Step {
    constructor() {
        super(...arguments);
        // tells `PipelineGraph` to hoist a "Source" step
        /**
         * Whether or not this is a Source step.
         *
         * What it means to be a Source step depends on the engine.
         *
         * @stability stable
         */
        this.isSource = true;
    }
    /**
     * Returns a GitHub source, using OAuth tokens to authenticate with GitHub and a separate webhook to detect changes.
     *
     * This is no longer
     * the recommended method. Please consider using `connection()`
     * instead.
     *
     * Pass in the owner and repository in a single string, like this:
     *
     * ```ts
     * pipelines.CodePipelineSource.gitHub('owner/repo', 'main');
     * ```
     *
     * Authentication will be done by a secret called `github-token` in AWS
     * Secrets Manager (unless specified otherwise).
     *
     * The token should have these permissions:
     *
     * * **repo** - to read the repository
     * * **admin:repo_hook** - if you plan to use webhooks (true by default)
     *
     * @stability stable
     */
    static gitHub(repoString, branch, props = {}) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_GitHubSourceOptions(props);
        return new GitHubSource(repoString, branch, props);
    }
    /**
     * Returns an S3 source.
     *
     * @param bucket The bucket where the source code is located.
     * @param props The options, which include the key that identifies the source code file and and how the pipeline should be triggered.
     * @stability stable
     */
    static s3(bucket, objectKey, props = {}) {
        jsiiDeprecationWarnings.aws_cdk_lib_aws_s3_IBucket(bucket);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_S3SourceOptions(props);
        return new S3Source(bucket, objectKey, props);
    }
    /**
     * Returns a CodeStar connection source.
     *
     * A CodeStar connection allows AWS CodePipeline to
     * access external resources, such as repositories in GitHub, GitHub Enterprise or
     * BitBucket.
     *
     * To use this method, you first need to create a CodeStar connection
     * using the AWS console. In the process, you may have to sign in to the external provider
     * -- GitHub, for example -- to authorize AWS to read and modify your repository.
     * Once you have done this, copy the connection ARN and use it to create the source.
     *
     * Example:
     *
     * ```ts
     * pipelines.CodePipelineSource.connection('owner/repo', 'main', {
     *    connectionArn: 'arn:aws:codestar-connections:us-east-1:222222222222:connection/7d2469ff-514a-4e4f-9003-5ca4a43cdc41', // Created using the AWS console
     * });
     * ```
     *
     * @param repoString A string that encodes owner and repository separated by a slash (e.g. 'owner/repo').
     * @param branch The branch to use.
     * @param props The source properties, including the connection ARN.
     * @see https://docs.aws.amazon.com/dtconsole/latest/userguide/welcome-connections.html
     * @stability stable
     */
    static connection(repoString, branch, props) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_ConnectionSourceOptions(props);
        return new CodeStarConnectionSource(repoString, branch, props);
    }
    /**
     * Returns a CodeCommit source.
     *
     * @param repository The CodeCommit repository.
     * @param branch The branch to use.
     * @param props The source properties.
     * @stability stable
     */
    static codeCommit(repository, branch, props = {}) {
        jsiiDeprecationWarnings.aws_cdk_lib_aws_codecommit_IRepository(repository);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_CodeCommitSourceOptions(props);
        return new CodeCommitSource(repository, branch, props);
    }
    /**
     * Create the desired Action and add it to the pipeline.
     *
     * @stability stable
     */
    produceAction(stage, options) {
        jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_IStage(stage);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_ProduceActionOptions(options);
        const output = options.artifacts.toCodePipeline(this.primaryOutput);
        const action = this.getAction(output, options.actionName, options.runOrder);
        stage.addAction(action);
        return { runOrdersConsumed: 1 };
    }
}
exports.CodePipelineSource = CodePipelineSource;
_a = JSII_RTTI_SYMBOL_1;
CodePipelineSource[_a] = { fqn: "aws-cdk-lib.pipelines.CodePipelineSource", version: "2.0.0" };
/**
 * Extend CodePipelineSource so we can type-test in the CodePipelineEngine.
 */
class GitHubSource extends CodePipelineSource {
    constructor(repoString, branch, props) {
        var _b;
        super(repoString);
        this.branch = branch;
        this.props = props;
        const parts = repoString.split('/');
        if (core_1.Token.isUnresolved(repoString) || parts.length !== 2) {
            throw new Error(`GitHub repository name should be a resolved string like '<owner>/<repo>', got '${repoString}'`);
        }
        this.owner = parts[0];
        this.repo = parts[1];
        this.authentication = (_b = props.authentication) !== null && _b !== void 0 ? _b : core_1.SecretValue.secretsManager('github-token');
        this.configurePrimaryOutput(new blueprint_1.FileSet('Source', this));
    }
    getAction(output, actionName, runOrder) {
        return new cp_actions.GitHubSourceAction({
            output,
            actionName,
            runOrder,
            oauthToken: this.authentication,
            owner: this.owner,
            repo: this.repo,
            branch: this.branch,
            trigger: this.props.trigger,
        });
    }
}
class S3Source extends CodePipelineSource {
    constructor(bucket, objectKey, props) {
        super(constructs_1.Node.of(bucket).addr);
        this.bucket = bucket;
        this.objectKey = objectKey;
        this.props = props;
        this.configurePrimaryOutput(new blueprint_1.FileSet('Source', this));
    }
    getAction(output, _actionName, runOrder) {
        var _b;
        return new cp_actions.S3SourceAction({
            output,
            // Bucket names are guaranteed to conform to ActionName restrictions
            actionName: (_b = this.props.actionName) !== null && _b !== void 0 ? _b : this.bucket.bucketName,
            runOrder,
            bucketKey: this.objectKey,
            trigger: this.props.trigger,
            bucket: this.bucket,
        });
    }
}
class CodeStarConnectionSource extends CodePipelineSource {
    constructor(repoString, branch, props) {
        super(repoString);
        this.branch = branch;
        this.props = props;
        const parts = repoString.split('/');
        if (core_1.Token.isUnresolved(repoString) || parts.length !== 2) {
            throw new Error(`CodeStar repository name should be a resolved string like '<owner>/<repo>', got '${repoString}'`);
        }
        this.owner = parts[0];
        this.repo = parts[1];
        this.configurePrimaryOutput(new blueprint_1.FileSet('Source', this));
    }
    getAction(output, actionName, runOrder) {
        return new cp_actions.CodeStarConnectionsSourceAction({
            output,
            actionName,
            runOrder,
            connectionArn: this.props.connectionArn,
            owner: this.owner,
            repo: this.repo,
            branch: this.branch,
            codeBuildCloneOutput: this.props.codeBuildCloneOutput,
            triggerOnPush: this.props.triggerOnPush,
        });
    }
}
class CodeCommitSource extends CodePipelineSource {
    constructor(repository, branch, props) {
        super(core_1.Token.isUnresolved(repository.repositoryName)
            ? constructs_1.Node.of(repository).addr
            : repository.repositoryName);
        this.repository = repository;
        this.branch = branch;
        this.props = props;
        this.configurePrimaryOutput(new blueprint_1.FileSet('Source', this));
    }
    getAction(output, _actionName, runOrder) {
        return new cp_actions.CodeCommitSourceAction({
            output,
            // Guaranteed to be okay as action name
            actionName: this.repository.repositoryName,
            runOrder,
            branch: this.branch,
            trigger: this.props.trigger,
            repository: this.repository,
            eventRole: this.props.eventRole,
            codeBuildCloneOutput: this.props.codeBuildCloneOutput,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZXBpcGVsaW5lLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvZGVwaXBlbGluZS1zb3VyY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0EsZ0VBQWdFO0FBSWhFLHdDQUFtRDtBQUNuRCwyQ0FBa0M7QUFDbEMsNENBQTZDOzs7Ozs7Ozs7QUFJN0MsTUFBc0Isa0JBQW1CLFNBQVEsZ0JBQUk7SUFBckQ7O1FBcUJFLGlEQUFpRDs7Ozs7Ozs7UUFDakMsYUFBUSxHQUFHLElBQUksQ0FBQztLQVVqQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBOUJRLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBa0IsRUFBRSxNQUFjLEVBQUUsUUFBNkIsRUFBRTs7UUFDdEYsT0FBTyxJQUFJLFlBQVksQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3BEOzs7Ozs7OztJQUdNLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBZSxFQUFFLFNBQWlCLEVBQUUsUUFBeUIsRUFBRTs7O1FBQzlFLE9BQU8sSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUMvQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBR00sTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFrQixFQUFFLE1BQWMsRUFBRSxLQUE4Qjs7UUFDekYsT0FBTyxJQUFJLHdCQUF3QixDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDaEU7Ozs7Ozs7OztJQUdNLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBa0MsRUFBRSxNQUFjLEVBQUUsUUFBaUMsRUFBRTs7O1FBQzlHLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3hEOzs7Ozs7SUFLTSxhQUFhLENBQUMsS0FBZ0IsRUFBRSxPQUE2Qjs7O1FBQ2xFLE1BQU0sTUFBTSxHQUFH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QUFrQyxFQUFtQixNQUFjLEVBQW1CLEtBQThCO1FBQy9JLEtBQUssQ0FBQyxZQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7WUFDakQsQ0FBQyxDQUFDLGlCQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUk7WUFDMUIsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUhKLGVBQVUsR0FBVixVQUFVLENBQXdCO1FBQW1CLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBbUIsVUFBSyxHQUFMLEtBQUssQ0FBeUI7UUFLL0ksSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksbUJBQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztLQUMxRDtJQUVTLFNBQVMsQ0FBQyxNQUFnQixFQUFFLFdBQW1CLEVBQUUsUUFBZ0I7UUFDekUsT0FBTyxJQUFJLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQztZQUMzQyxNQUFNO1lBQ04sdUNBQXVDO1lBQ3ZDLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWM7WUFDMUMsUUFBUTtZQUNSLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNuQixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPO1lBQzNCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUMzQixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO1lBQy9CLG9CQUFvQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CO1NBQ3RELENBQUMsQ0FBQztLQUNKO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb2RlY29tbWl0IGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlY29tbWl0JztcbmltcG9ydCAqIGFzIGNwIGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlcGlwZWxpbmUnO1xuaW1wb3J0IHsgQXJ0aWZhY3QgfSBmcm9tICcuLi8uLi8uLi9hd3MtY29kZXBpcGVsaW5lJztcbmltcG9ydCAqIGFzIGNwX2FjdGlvbnMgZnJvbSAnLi4vLi4vLi4vYXdzLWNvZGVwaXBlbGluZS1hY3Rpb25zJztcbmltcG9ydCB7IEFjdGlvbiwgQ29kZUNvbW1pdFRyaWdnZXIsIEdpdEh1YlRyaWdnZXIsIFMzVHJpZ2dlciB9IGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlcGlwZWxpbmUtYWN0aW9ucyc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgeyBJQnVja2V0IH0gZnJvbSAnLi4vLi4vLi4vYXdzLXMzJztcbmltcG9ydCB7IFNlY3JldFZhbHVlLCBUb2tlbiB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgTm9kZSB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgRmlsZVNldCwgU3RlcCB9IGZyb20gJy4uL2JsdWVwcmludCc7XG5pbXBvcnQgeyBDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5UmVzdWx0LCBQcm9kdWNlQWN0aW9uT3B0aW9ucywgSUNvZGVQaXBlbGluZUFjdGlvbkZhY3RvcnkgfSBmcm9tICcuL2NvZGVwaXBlbGluZS1hY3Rpb24tZmFjdG9yeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIENvZGVQaXBlbGluZVNvdXJjZSBleHRlbmRzIFN0ZXAgaW1wbGVtZW50cyBJQ29kZVBpcGVsaW5lQWN0aW9uRmFjdG9yeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgc3RhdGljIGdpdEh1YihyZXBvU3RyaW5nOiBzdHJpbmcsIGJyYW5jaDogc3RyaW5nLCBwcm9wczogR2l0SHViU291cmNlT3B0aW9ucyA9IHt9KTogQ29kZVBpcGVsaW5lU291cmNlIHtcbiAgICByZXR1cm4gbmV3IEdpdEh1YlNvdXJjZShyZXBvU3RyaW5nLCBicmFuY2gsIHByb3BzKTtcbiAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyBzdGF0aWMgczMoYnVja2V0OiBJQnVja2V0LCBvYmplY3RLZXk6IHN0cmluZywgcHJvcHM6IFMzU291cmNlT3B0aW9ucyA9IHt9KTogQ29kZVBpcGVsaW5lU291cmNlIHtcbiAgICByZXR1cm4gbmV3IFMzU291cmNlKGJ1Y2tldCwgb2JqZWN0S2V5LCBwcm9wcyk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHN0YXRpYyBjb25uZWN0aW9uKHJlcG9TdHJpbmc6IHN0cmluZywgYnJhbmNoOiBzdHJpbmcsIHByb3BzOiBDb25uZWN0aW9uU291cmNlT3B0aW9ucyk6IENvZGVQaXBlbGluZVNvdXJjZSB7XG4gICAgcmV0dXJuIG5ldyBDb2RlU3RhckNvbm5lY3Rpb25Tb3VyY2UocmVwb1N0cmluZywgYnJhbmNoLCBwcm9wcyk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHN0YXRpYyBjb2RlQ29tbWl0KHJlcG9zaXRvcnk6IGNvZGVjb21taXQuSVJlcG9zaXRvcnksIGJyYW5jaDogc3RyaW5nLCBwcm9wczogQ29kZUNvbW1pdFNvdXJjZU9wdGlvbnMgPSB7fSk6IENvZGVQaXBlbGluZVNvdXJjZSB7XG4gICAgcmV0dXJuIG5ldyBDb2RlQ29tbWl0U291cmNlKHJlcG9zaXRvcnksIGJyYW5jaCwgcHJvcHMpO1xuICB9XG5cbiAgLy8gdGVsbHMgYFBpcGVsaW5lR3JhcGhgIHRvIGhvaXN0IGEgXCJTb3VyY2VcIiBzdGVwXG4gIHB1YmxpYyByZWFkb25seSBpc1NvdXJjZSA9IHRydWU7XG5cbiAgcHVibGljIHByb2R1Y2VBY3Rpb24oc3RhZ2U6IGNwLklTdGFnZSwgb3B0aW9uczogUHJvZHVjZUFjdGlvbk9wdGlvbnMpOiBDb2RlUGlwZWxpbmVBY3Rpb25GYWN0b3J5UmVzdWx0IHtcbiAgICBjb25zdCBvdXRwdXQgPSBvcHRpb25zLmFydGlmYWN0cy50b0NvZGVQaXBlbGluZSh0aGlzLnByaW1hcnlPdXRwdXQhKTtcbiAgICBjb25zdCBhY3Rpb24gPSB0aGlzLmdldEFjdGlvbihvdXRwdXQsIG9wdGlvbnMuYWN0aW9uTmFtZSwgb3B0aW9ucy5ydW5PcmRlcik7XG4gICAgc3RhZ2UuYWRkQWN0aW9uKGFjdGlvbik7XG4gICAgcmV0dXJuIHsgcnVuT3JkZXJzQ29uc3VtZWQ6IDEgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRBY3Rpb24ob3V0cHV0OiBBcnRpZmFjdCwgYWN0aW9uTmFtZTogc3RyaW5nLCBydW5PcmRlcjogbnVtYmVyKTogQWN0aW9uO1xufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgaW50ZXJmYWNlIEdpdEh1YlNvdXJjZU9wdGlvbnMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBhdXRoZW50aWNhdGlvbj86IFNlY3JldFZhbHVlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgdHJpZ2dlcj86IEdpdEh1YlRyaWdnZXI7XG5cbn1cblxuLyoqXG4gKiBFeHRlbmQgQ29kZVBpcGVsaW5lU291cmNlIHNvIHdlIGNhbiB0eXBlLXRlc3QgaW4gdGhlIENvZGVQaXBlbGluZUVuZ2luZS5cbiAqL1xuY2xhc3MgR2l0SHViU291cmNlIGV4dGVuZHMgQ29kZVBpcGVsaW5lU291cmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBvd25lcjogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcG86IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBhdXRoZW50aWNhdGlvbjogU2VjcmV0VmFsdWU7XG5cbiAgY29uc3RydWN0b3IocmVwb1N0cmluZzogc3RyaW5nLCByZWFkb25seSBicmFuY2g6IHN0cmluZywgcmVhZG9ubHkgcHJvcHM6IEdpdEh1YlNvdXJjZU9wdGlvbnMpIHtcbiAgICBzdXBlcihyZXBvU3RyaW5nKTtcblxuICAgIGNvbnN0IHBhcnRzID0gcmVwb1N0cmluZy5zcGxpdCgnLycpO1xuICAgIGlmIChUb2tlbi5pc1VucmVzb2x2ZWQocmVwb1N0cmluZykgfHwgcGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEdpdEh1YiByZXBvc2l0b3J5IG5hbWUgc2hvdWxkIGJlIGEgcmVzb2x2ZWQgc3RyaW5nIGxpa2UgJzxvd25lcj4vPHJlcG8+JywgZ290ICcke3JlcG9TdHJpbmd9J2ApO1xuICAgIH1cbiAgICB0aGlzLm93bmVyID0gcGFydHNbMF07XG4gICAgdGhpcy5yZXBvID0gcGFydHNbMV07XG4gICAgdGhpcy5hdXRoZW50aWNhdGlvbiA9IHByb3BzLmF1dGhlbnRpY2F0aW9uID8/IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKCdnaXRodWItdG9rZW4nKTtcbiAgICB0aGlzLmNvbmZpZ3VyZVByaW1hcnlPdXRwdXQobmV3IEZpbGVTZXQoJ1NvdXJjZScsIHRoaXMpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRBY3Rpb24ob3V0cHV0OiBBcnRpZmFjdCwgYWN0aW9uTmFtZTogc3RyaW5nLCBydW5PcmRlcjogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBjcF9hY3Rpb25zLkdpdEh1YlNvdXJjZUFjdGlvbih7XG4gICAgICBvdXRwdXQsXG4gICAgICBhY3Rpb25OYW1lLFxuICAgICAgcnVuT3JkZXIsXG4gICAgICBvYXV0aFRva2VuOiB0aGlzLmF1dGhlbnRpY2F0aW9uLFxuICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICBicmFuY2g6IHRoaXMuYnJhbmNoLFxuICAgICAgdHJpZ2dlcjogdGhpcy5wcm9wcy50cmlnZ2VyLFxuICAgIH0pO1xuICB9XG59XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGludGVyZmFjZSBTM1NvdXJjZU9wdGlvbnMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSB0cmlnZ2VyPzogUzNUcmlnZ2VyO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBhY3Rpb25OYW1lPzogc3RyaW5nO1xufVxuXG5jbGFzcyBTM1NvdXJjZSBleHRlbmRzIENvZGVQaXBlbGluZVNvdXJjZSB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGJ1Y2tldDogSUJ1Y2tldCwgcHJpdmF0ZSByZWFkb25seSBvYmplY3RLZXk6IHN0cmluZywgcmVhZG9ubHkgcHJvcHM6IFMzU291cmNlT3B0aW9ucykge1xuICAgIHN1cGVyKE5vZGUub2YoYnVja2V0KS5hZGRyKTtcblxuICAgIHRoaXMuY29uZmlndXJlUHJpbWFyeU91dHB1dChuZXcgRmlsZVNldCgnU291cmNlJywgdGhpcykpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldEFjdGlvbihvdXRwdXQ6IEFydGlmYWN0LCBfYWN0aW9uTmFtZTogc3RyaW5nLCBydW5PcmRlcjogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBjcF9hY3Rpb25zLlMzU291cmNlQWN0aW9uKHtcbiAgICAgIG91dHB1dCxcbiAgICAgIC8vIEJ1Y2tldCBuYW1lcyBhcmUgZ3VhcmFudGVlZCB0byBjb25mb3JtIHRvIEFjdGlvbk5hbWUgcmVzdHJpY3Rpb25zXG4gICAgICBhY3Rpb25OYW1lOiB0aGlzLnByb3BzLmFjdGlvbk5hbWUgPz8gdGhpcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIHJ1bk9yZGVyLFxuICAgICAgYnVja2V0S2V5OiB0aGlzLm9iamVjdEtleSxcbiAgICAgIHRyaWdnZXI6IHRoaXMucHJvcHMudHJpZ2dlcixcbiAgICAgIGJ1Y2tldDogdGhpcy5idWNrZXQsXG4gICAgfSk7XG4gIH1cbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uU291cmNlT3B0aW9ucyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBjb25uZWN0aW9uQXJuOiBzdHJpbmc7XG5cblxuICAvLyBsb25nIFVSTCBpbiBAc2VlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGNvZGVCdWlsZENsb25lT3V0cHV0PzogYm9vbGVhbjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSB0cmlnZ2VyT25QdXNoPzogYm9vbGVhbjtcbn1cblxuY2xhc3MgQ29kZVN0YXJDb25uZWN0aW9uU291cmNlIGV4dGVuZHMgQ29kZVBpcGVsaW5lU291cmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBvd25lcjogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlcG86IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihyZXBvU3RyaW5nOiBzdHJpbmcsIHJlYWRvbmx5IGJyYW5jaDogc3RyaW5nLCByZWFkb25seSBwcm9wczogQ29ubmVjdGlvblNvdXJjZU9wdGlvbnMpIHtcbiAgICBzdXBlcihyZXBvU3RyaW5nKTtcblxuICAgIGNvbnN0IHBhcnRzID0gcmVwb1N0cmluZy5zcGxpdCgnLycpO1xuICAgIGlmIChUb2tlbi5pc1VucmVzb2x2ZWQocmVwb1N0cmluZykgfHwgcGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvZGVTdGFyIHJlcG9zaXRvcnkgbmFtZSBzaG91bGQgYmUgYSByZXNvbHZlZCBzdHJpbmcgbGlrZSAnPG93bmVyPi88cmVwbz4nLCBnb3QgJyR7cmVwb1N0cmluZ30nYCk7XG4gICAgfVxuICAgIHRoaXMub3duZXIgPSBwYXJ0c1swXTtcbiAgICB0aGlzLnJlcG8gPSBwYXJ0c1sxXTtcbiAgICB0aGlzLmNvbmZpZ3VyZVByaW1hcnlPdXRwdXQobmV3IEZpbGVTZXQoJ1NvdXJjZScsIHRoaXMpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRBY3Rpb24ob3V0cHV0OiBBcnRpZmFjdCwgYWN0aW9uTmFtZTogc3RyaW5nLCBydW5PcmRlcjogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBjcF9hY3Rpb25zLkNvZGVTdGFyQ29ubmVjdGlvbnNTb3VyY2VBY3Rpb24oe1xuICAgICAgb3V0cHV0LFxuICAgICAgYWN0aW9uTmFtZSxcbiAgICAgIHJ1bk9yZGVyLFxuICAgICAgY29ubmVjdGlvbkFybjogdGhpcy5wcm9wcy5jb25uZWN0aW9uQXJuLFxuICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICBicmFuY2g6IHRoaXMuYnJhbmNoLFxuICAgICAgY29kZUJ1aWxkQ2xvbmVPdXRwdXQ6IHRoaXMucHJvcHMuY29kZUJ1aWxkQ2xvbmVPdXRwdXQsXG4gICAgICB0cmlnZ2VyT25QdXNoOiB0aGlzLnByb3BzLnRyaWdnZXJPblB1c2gsXG4gICAgfSk7XG4gIH1cbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgQ29kZUNvbW1pdFNvdXJjZU9wdGlvbnMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHRyaWdnZXI/OiBDb2RlQ29tbWl0VHJpZ2dlcjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgZXZlbnRSb2xlPzogaWFtLklSb2xlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGNvZGVCdWlsZENsb25lT3V0cHV0PzogYm9vbGVhbjtcbn1cblxuY2xhc3MgQ29kZUNvbW1pdFNvdXJjZSBleHRlbmRzIENvZGVQaXBlbGluZVNvdXJjZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcmVwb3NpdG9yeTogY29kZWNvbW1pdC5JUmVwb3NpdG9yeSwgcHJpdmF0ZSByZWFkb25seSBicmFuY2g6IHN0cmluZywgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQ29kZUNvbW1pdFNvdXJjZU9wdGlvbnMpIHtcbiAgICBzdXBlcihUb2tlbi5pc1VucmVzb2x2ZWQocmVwb3NpdG9yeS5yZXBvc2l0b3J5TmFtZSlcbiAgICAgID8gTm9kZS5vZihyZXBvc2l0b3J5KS5hZGRyXG4gICAgICA6IHJlcG9zaXRvcnkucmVwb3NpdG9yeU5hbWUpO1xuXG4gICAgdGhpcy5jb25maWd1cmVQcmltYXJ5T3V0cHV0KG5ldyBGaWxlU2V0KCdTb3VyY2UnLCB0aGlzKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0QWN0aW9uKG91dHB1dDogQXJ0aWZhY3QsIF9hY3Rpb25OYW1lOiBzdHJpbmcsIHJ1bk9yZGVyOiBudW1iZXIpIHtcbiAgICByZXR1cm4gbmV3IGNwX2FjdGlvbnMuQ29kZUNvbW1pdFNvdXJjZUFjdGlvbih7XG4gICAgICBvdXRwdXQsXG4gICAgICAvLyBHdWFyYW50ZWVkIHRvIGJlIG9rYXkgYXMgYWN0aW9uIG5hbWVcbiAgICAgIGFjdGlvbk5hbWU6IHRoaXMucmVwb3NpdG9yeS5yZXBvc2l0b3J5TmFtZSxcbiAgICAgIHJ1bk9yZGVyLFxuICAgICAgYnJhbmNoOiB0aGlzLmJyYW5jaCxcbiAgICAgIHRyaWdnZXI6IHRoaXMucHJvcHMudHJpZ2dlcixcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMucmVwb3NpdG9yeSxcbiAgICAgIGV2ZW50Um9sZTogdGhpcy5wcm9wcy5ldmVudFJvbGUsXG4gICAgICBjb2RlQnVpbGRDbG9uZU91dHB1dDogdGhpcy5wcm9wcy5jb2RlQnVpbGRDbG9uZU91dHB1dCxcbiAgICB9KTtcbiAgfVxufSJdfQ==