"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.dockerCredentialsInstallCommands = exports.DockerCredentialUsage = exports.DockerCredential = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const ec2 = require("../../aws-ec2");
const iam = require("../../aws-iam");
const core_1 = require("../../core");
/**
 * Represents credentials used to access a Docker registry.
 *
 * @stability stable
 */
class DockerCredential {
    /**
     * @stability stable
     */
    constructor(usages) {
        this.usages = usages;
    }
    /**
     * Creates a DockerCredential for DockerHub.
     *
     * Convenience method for `fromCustomRegistry('index.docker.io', opts)`.
     *
     * @stability stable
     */
    static dockerHub(secret, opts = {}) {
        jsiiDeprecationWarnings.aws_cdk_lib_aws_secretsmanager_ISecret(secret);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_ExternalDockerCredentialOptions(opts);
        return new ExternalDockerCredential('index.docker.io', secret, opts);
    }
    /**
     * Creates a DockerCredential for a registry, based on its domain name (e.g., 'www.example.com').
     *
     * @stability stable
     */
    static customRegistry(registryDomain, secret, opts = {}) {
        jsiiDeprecationWarnings.aws_cdk_lib_aws_secretsmanager_ISecret(secret);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_ExternalDockerCredentialOptions(opts);
        return new ExternalDockerCredential(registryDomain, secret, opts);
    }
    /**
     * Creates a DockerCredential for one or more ECR repositories.
     *
     * NOTE - All ECR repositories in the same account and region share a domain name
     * (e.g., 0123456789012.dkr.ecr.eu-west-1.amazonaws.com), and can only have one associated
     * set of credentials (and DockerCredential). Attempting to associate one set of credentials
     * with one ECR repo and another with another ECR repo in the same account and region will
     * result in failures when using these credentials in the pipeline.
     *
     * @stability stable
     */
    static ecr(repositories, opts) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_EcrDockerCredentialOptions(opts);
        return new EcrDockerCredential(repositories, opts !== null && opts !== void 0 ? opts : {});
    }
    /**
     * Determines if this credential is relevant to the input usage.
     * @internal
     */
    _applicableForUsage(usage) {
        return !this.usages || this.usages.includes(usage);
    }
}
exports.DockerCredential = DockerCredential;
_a = JSII_RTTI_SYMBOL_1;
DockerCredential[_a] = { fqn: "aws-cdk-lib.pipelines.DockerCredential", version: "2.0.0" };
/**
 * Defines which stages of a pipeline require the specified credentials.
 *
 * @stability stable
 */
var DockerCredentialUsage;
(function (DockerCredentialUsage) {
    DockerCredentialUsage["SYNTH"] = "SYNTH";
    DockerCredentialUsage["SELF_UPDATE"] = "SELF_UPDATE";
    DockerCredentialUsage["ASSET_PUBLISHING"] = "ASSET_PUBLISHING";
})(DockerCredentialUsage = exports.DockerCredentialUsage || (exports.DockerCredentialUsage = {}));
;
/** DockerCredential defined by registry domain and a secret */
class ExternalDockerCredential extends DockerCredential {
    constructor(registryDomain, secret, opts) {
        super(opts.usages);
        this.registryDomain = registryDomain;
        this.secret = secret;
        this.opts = opts;
    }
    grantRead(grantee, usage) {
        var _b;
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = (_b = this.opts.assumeRole) !== null && _b !== void 0 ? _b : grantee;
        this.secret.grantRead(role);
    }
    _renderCdkAssetsConfig() {
        var _b;
        return {
            [this.registryDomain]: {
                secretsManagerSecretId: this.secret.secretArn,
                secretsUsernameField: this.opts.secretUsernameField,
                secretsPasswordField: this.opts.secretPasswordField,
                assumeRoleArn: (_b = this.opts.assumeRole) === null || _b === void 0 ? void 0 : _b.roleArn,
            },
        };
    }
}
/** DockerCredential defined by a set of ECR repositories in the same account & region */
class EcrDockerCredential extends DockerCredential {
    constructor(repositories, opts) {
        super(opts.usages);
        this.repositories = repositories;
        this.opts = opts;
        if (repositories.length === 0) {
            throw new Error('must supply at least one `ecr.IRepository` to create an `EcrDockerCredential`');
        }
        this.registryDomain = core_1.Fn.select(0, core_1.Fn.split('/', repositories[0].repositoryUri));
    }
    grantRead(grantee, usage) {
        var _b;
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = (_b = this.opts.assumeRole) !== null && _b !== void 0 ? _b : grantee;
        this.repositories.forEach(repo => repo.grantPull(role));
    }
    _renderCdkAssetsConfig() {
        var _b;
        return {
            [this.registryDomain]: {
                ecrRepository: true,
                assumeRoleArn: (_b = this.opts.assumeRole) === null || _b === void 0 ? void 0 : _b.roleArn,
            },
        };
    }
}
/**
 * Creates a set of OS-specific buildspec installation commands for setting up the given
 * registries and associated credentials.
 *
 * @param registries - Registries to configure credentials for. It is an error to provide
 * multiple registries for the same domain.
 * @param osType - (optional) Defaults to Linux.
 * @returns An array of commands to configure cdk-assets to use these credentials.
 */
function dockerCredentialsInstallCommands(usage, registries, osType) {
    const relevantRegistries = (registries !== null && registries !== void 0 ? registries : []).filter(reg => reg._applicableForUsage(usage));
    if (!relevantRegistries || relevantRegistries.length === 0) {
        return [];
    }
    const domainCredentials = relevantRegistries.reduce(function (map, registry) {
        Object.assign(map, registry._renderCdkAssetsConfig());
        return map;
    }, {});
    const cdkAssetsConfigFile = {
        version: '1.0',
        domainCredentials,
    };
    const windowsCommands = [
        'mkdir %USERPROFILE%\\.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > %USERPROFILE%\\.cdk\\cdk-docker-creds.json`,
    ];
    const linuxCommands = [
        'mkdir $HOME/.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > $HOME/.cdk/cdk-docker-creds.json`,
    ];
    if (osType === 'both') {
        return [
            // These tags are magic and will be stripped when rendering the project
            ...windowsCommands.map(c => `!WINDOWS!${c}`),
            ...linuxCommands.map(c => `!LINUX!${c}`),
        ];
    }
    else if (osType === ec2.OperatingSystemType.WINDOWS) {
        return windowsCommands;
    }
    else {
        return linuxCommands;
    }
}
exports.dockerCredentialsInstallCommands = dockerCredentialsInstallCommands;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLWNyZWRlbnRpYWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLWNyZWRlbnRpYWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHFDQUFxQztBQUVyQyxxQ0FBcUM7QUFFckMscUNBQWdDOzs7Ozs7QUFHaEMsTUFBc0IsZ0JBQWdCOzs7O0lBbUJwQyxZQUErQixNQUFnQztRQUFoQyxXQUFNLEdBQU4sTUFBTSxDQUEwQjtLQUFLOzs7Ozs7OztJQWpCN0QsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUE4QixFQUFFLE9BQXdDLEVBQUU7OztRQUNoRyxPQUFPLElBQUksd0JBQXdCLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3RFOzs7Ozs7SUFHTSxNQUFNLENBQUMsY0FBYyxDQUMxQixjQUFzQixFQUN0QixNQUE4QixFQUM5QixPQUF3QyxFQUFFOzs7UUFDMUMsT0FBTyxJQUFJLHdCQUF3QixDQUFDLGNBQWMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDbkU7Ozs7Ozs7Ozs7OztJQUdNLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBK0IsRUFBRSxJQUFpQzs7UUFDbEYsT0FBTyxJQUFJLG1CQUFtQixDQUFDLFlBQVksRUFBRSxJQUFJLGFBQUosSUFBSSxjQUFKLElBQUksR0FBSSxFQUFFLENBQUMsQ0FBQztLQUMxRDtJQUlEOzs7T0FHRztJQUNJLG1CQUFtQixDQUFDLEtBQTRCO1FBQ3JELE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3BEOztBQTNCSCw0Q0FzQ0M7Ozs7Ozs7O0FBdUJELElBQVkscUJBT1g7QUFQRCxXQUFZLHFCQUFxQjtJQUUvQix3Q0FBZSxDQUFBO0lBRWYsb0RBQTJCLENBQUE7SUFFM0IsOERBQXFDLENBQUE7QUFDdkMsQ0FBQyxFQVBXLHFCQUFx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QixTQUFTLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsc0NBQXNDO0tBQ25GLENBQUM7SUFFRixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7UUFDckIsT0FBTztZQUNMLHVFQUF1RTtZQUN2RSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQzVDLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7U0FDekMsQ0FBQztLQUNIO1NBQU0sSUFBSSxNQUFNLEtBQUssR0FBRyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRTtRQUNyRCxPQUFPLGVBQWUsQ0FBQztLQUN4QjtTQUFNO1FBQ0wsT0FBTyxhQUFhLENBQUM7S0FDdEI7QUFDSCxDQUFDO0FBdENELDRFQXNDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGVjMiBmcm9tICcuLi8uLi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGVjciBmcm9tICcuLi8uLi9hd3MtZWNyJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICcuLi8uLi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIHNlY3JldHNtYW5hZ2VyIGZyb20gJy4uLy4uL2F3cy1zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgeyBGbiB9IGZyb20gJy4uLy4uL2NvcmUnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyBzdGF0aWMgZG9ja2VySHViKHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCwgb3B0czogRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsT3B0aW9ucyA9IHt9KTogRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgcmV0dXJuIG5ldyBFeHRlcm5hbERvY2tlckNyZWRlbnRpYWwoJ2luZGV4LmRvY2tlci5pbycsIHNlY3JldCwgb3B0cyk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyBzdGF0aWMgY3VzdG9tUmVnaXN0cnkoXG4gICAgcmVnaXN0cnlEb21haW46IHN0cmluZyxcbiAgICBzZWNyZXQ6IHNlY3JldHNtYW5hZ2VyLklTZWNyZXQsXG4gICAgb3B0czogRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsT3B0aW9ucyA9IHt9KTogRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgcmV0dXJuIG5ldyBFeHRlcm5hbERvY2tlckNyZWRlbnRpYWwocmVnaXN0cnlEb21haW4sIHNlY3JldCwgb3B0cyk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgc3RhdGljIGVjcihyZXBvc2l0b3JpZXM6IGVjci5JUmVwb3NpdG9yeVtdLCBvcHRzPzogRWNyRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMpOiBEb2NrZXJDcmVkZW50aWFsIHtcbiAgICByZXR1cm4gbmV3IEVjckRvY2tlckNyZWRlbnRpYWwocmVwb3NpdG9yaWVzLCBvcHRzID8/IHt9KTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSB1c2FnZXM/OiBEb2NrZXJDcmVkZW50aWFsVXNhZ2VbXSkgeyB9XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgaWYgdGhpcyBjcmVkZW50aWFsIGlzIHJlbGV2YW50IHRvIHRoZSBpbnB1dCB1c2FnZS5cbiAgICogQGludGVybmFsXG4gICAqL1xuICBwdWJsaWMgX2FwcGxpY2FibGVGb3JVc2FnZSh1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKSB7XG4gICAgcmV0dXJuICF0aGlzLnVzYWdlcyB8fCB0aGlzLnVzYWdlcy5pbmNsdWRlcyh1c2FnZSk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyBhYnN0cmFjdCBncmFudFJlYWQoZ3JhbnRlZTogaWFtLklHcmFudGFibGUsIHVzYWdlOiBEb2NrZXJDcmVkZW50aWFsVXNhZ2UpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIHRoZSBjcmVkZW50aWFsIGNvbmZpZ3VyYXRpb24sIHRvIGJlIHVzZWQgYnkgYGNkay1hc3NldHNgXG4gICAqIHRvIHN1cHBvcnQgdGhlIGBkb2NrZXItY3JlZGVudGlhbC1jZGstYXNzZXRzYCB0b29sIGZvciBgZG9ja2VyIGxvZ2luYC5cbiAgICogQGludGVybmFsXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgX3JlbmRlckNka0Fzc2V0c0NvbmZpZygpOiBEb2NrZXJDcmVkZW50aWFsQ3JlZGVudGlhbFNvdXJjZVxufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsT3B0aW9ucyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHNlY3JldFVzZXJuYW1lRmllbGQ/OiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBzZWNyZXRQYXNzd29yZEZpZWxkPzogc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGFzc3VtZVJvbGU/OiBpYW0uSVJvbGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSB1c2FnZXM/OiBEb2NrZXJDcmVkZW50aWFsVXNhZ2VbXTtcbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgRWNyRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGFzc3VtZVJvbGU/OiBpYW0uSVJvbGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSB1c2FnZXM/OiBEb2NrZXJDcmVkZW50aWFsVXNhZ2VbXTtcbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgZW51bSBEb2NrZXJDcmVkZW50aWFsVXNhZ2Uge1xuICAgICAgICAgICAgICAgICAgICBcbiAgU1lOVEggPSAnU1lOVEgnLFxuICAgICAgICAgICAgICAgICAgICBcbiAgU0VMRl9VUERBVEUgPSAnU0VMRl9VUERBVEUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBBU1NFVF9QVUJMSVNISU5HID0gJ0FTU0VUX1BVQkxJU0hJTkcnLFxufTtcblxuLyoqIERvY2tlckNyZWRlbnRpYWwgZGVmaW5lZCBieSByZWdpc3RyeSBkb21haW4gYW5kIGEgc2VjcmV0ICovXG5jbGFzcyBFeHRlcm5hbERvY2tlckNyZWRlbnRpYWwgZXh0ZW5kcyBEb2NrZXJDcmVkZW50aWFsIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSByZWdpc3RyeURvbWFpbjogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2VjcmV0OiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0czogRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsT3B0aW9ucykge1xuICAgIHN1cGVyKG9wdHMudXNhZ2VzKTtcbiAgfVxuXG4gIHB1YmxpYyBncmFudFJlYWQoZ3JhbnRlZTogaWFtLklHcmFudGFibGUsIHVzYWdlOiBEb2NrZXJDcmVkZW50aWFsVXNhZ2UpIHtcbiAgICBpZiAoIXRoaXMuX2FwcGxpY2FibGVGb3JVc2FnZSh1c2FnZSkpIHsgcmV0dXJuOyB9XG5cbiAgICBpZiAodGhpcy5vcHRzLmFzc3VtZVJvbGUpIHtcbiAgICAgIGdyYW50ZWUuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbJ3N0czpBc3N1bWVSb2xlJ10sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMub3B0cy5hc3N1bWVSb2xlLnJvbGVBcm5dLFxuICAgICAgfSkpO1xuICAgIH1cbiAgICBjb25zdCByb2xlID0gdGhpcy5vcHRzLmFzc3VtZVJvbGUgPz8gZ3JhbnRlZTtcbiAgICB0aGlzLnNlY3JldC5ncmFudFJlYWQocm9sZSk7XG4gIH1cblxuICBwdWJsaWMgX3JlbmRlckNka0Fzc2V0c0NvbmZpZygpOiBEb2NrZXJDcmVkZW50aWFsQ3JlZGVudGlhbFNvdXJjZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFt0aGlzLnJlZ2lzdHJ5RG9tYWluXToge1xuICAgICAgICBzZWNyZXRzTWFuYWdlclNlY3JldElkOiB0aGlzLnNlY3JldC5zZWNyZXRBcm4sXG4gICAgICAgIHNlY3JldHNVc2VybmFtZUZpZWxkOiB0aGlzLm9wdHMuc2VjcmV0VXNlcm5hbWVGaWVsZCxcbiAgICAgICAgc2VjcmV0c1Bhc3N3b3JkRmllbGQ6IHRoaXMub3B0cy5zZWNyZXRQYXNzd29yZEZpZWxkLFxuICAgICAgICBhc3N1bWVSb2xlQXJuOiB0aGlzLm9wdHMuYXNzdW1lUm9sZT8ucm9sZUFybixcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG4vKiogRG9ja2VyQ3JlZGVudGlhbCBkZWZpbmVkIGJ5IGEgc2V0IG9mIEVDUiByZXBvc2l0b3JpZXMgaW4gdGhlIHNhbWUgYWNjb3VudCAmIHJlZ2lvbiAqL1xuY2xhc3MgRWNyRG9ja2VyQ3JlZGVudGlhbCBleHRlbmRzIERvY2tlckNyZWRlbnRpYWwge1xuICBwdWJsaWMgcmVhZG9ubHkgcmVnaXN0cnlEb21haW46IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJlcG9zaXRvcmllczogZWNyLklSZXBvc2l0b3J5W10sIHByaXZhdGUgcmVhZG9ubHkgb3B0czogRWNyRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRzLnVzYWdlcyk7XG5cbiAgICBpZiAocmVwb3NpdG9yaWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IHN1cHBseSBhdCBsZWFzdCBvbmUgYGVjci5JUmVwb3NpdG9yeWAgdG8gY3JlYXRlIGFuIGBFY3JEb2NrZXJDcmVkZW50aWFsYCcpO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5RG9tYWluID0gRm4uc2VsZWN0KDAsIEZuLnNwbGl0KCcvJywgcmVwb3NpdG9yaWVzWzBdLnJlcG9zaXRvcnlVcmkpKTtcbiAgfVxuXG4gIHB1YmxpYyBncmFudFJlYWQoZ3JhbnRlZTogaWFtLklHcmFudGFibGUsIHVzYWdlOiBEb2NrZXJDcmVkZW50aWFsVXNhZ2UpIHtcbiAgICBpZiAoIXRoaXMuX2FwcGxpY2FibGVGb3JVc2FnZSh1c2FnZSkpIHsgcmV0dXJuOyB9XG5cbiAgICBpZiAodGhpcy5vcHRzLmFzc3VtZVJvbGUpIHtcbiAgICAgIGdyYW50ZWUuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbJ3N0czpBc3N1bWVSb2xlJ10sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMub3B0cy5hc3N1bWVSb2xlLnJvbGVBcm5dLFxuICAgICAgfSkpO1xuICAgIH1cbiAgICBjb25zdCByb2xlID0gdGhpcy5vcHRzLmFzc3VtZVJvbGUgPz8gZ3JhbnRlZTtcbiAgICB0aGlzLnJlcG9zaXRvcmllcy5mb3JFYWNoKHJlcG8gPT4gcmVwby5ncmFudFB1bGwocm9sZSkpO1xuICB9XG5cbiAgcHVibGljIF9yZW5kZXJDZGtBc3NldHNDb25maWcoKTogRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Uge1xuICAgIHJldHVybiB7XG4gICAgICBbdGhpcy5yZWdpc3RyeURvbWFpbl06IHtcbiAgICAgICAgZWNyUmVwb3NpdG9yeTogdHJ1ZSxcbiAgICAgICAgYXNzdW1lUm9sZUFybjogdGhpcy5vcHRzLmFzc3VtZVJvbGU/LnJvbGVBcm4sXG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqIEZvcm1hdCBmb3IgdGhlIENESyBhc3NldHMgY29uZmlnLiBTZWUgdGhlIGNkay1hc3NldHMgYERvY2tlckRvbWFpbkNyZWRlbnRpYWxTb3VyY2VgICovXG5pbnRlcmZhY2UgRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Uge1xuICByZWFkb25seSBzZWNyZXRzTWFuYWdlclNlY3JldElkPzogc3RyaW5nO1xuICByZWFkb25seSBzZWNyZXRzVXNlcm5hbWVGaWVsZD86IHN0cmluZztcbiAgcmVhZG9ubHkgc2VjcmV0c1Bhc3N3b3JkRmllbGQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGVjclJlcG9zaXRvcnk/OiBib29sZWFuO1xuICByZWFkb25seSBhc3N1bWVSb2xlQXJuPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBzZXQgb2YgT1Mtc3BlY2lmaWMgYnVpbGRzcGVjIGluc3RhbGxhdGlvbiBjb21tYW5kcyBmb3Igc2V0dGluZyB1cCB0aGUgZ2l2ZW5cbiAqIHJlZ2lzdHJpZXMgYW5kIGFzc29jaWF0ZWQgY3JlZGVudGlhbHMuXG4gKlxuICogQHBhcmFtIHJlZ2lzdHJpZXMgLSBSZWdpc3RyaWVzIHRvIGNvbmZpZ3VyZSBjcmVkZW50aWFscyBmb3IuIEl0IGlzIGFuIGVycm9yIHRvIHByb3ZpZGVcbiAqIG11bHRpcGxlIHJlZ2lzdHJpZXMgZm9yIHRoZSBzYW1lIGRvbWFpbi5cbiAqIEBwYXJhbSBvc1R5cGUgLSAob3B0aW9uYWwpIERlZmF1bHRzIHRvIExpbnV4LlxuICogQHJldHVybnMgQW4gYXJyYXkgb2YgY29tbWFuZHMgdG8gY29uZmlndXJlIGNkay1hc3NldHMgdG8gdXNlIHRoZXNlIGNyZWRlbnRpYWxzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZG9ja2VyQ3JlZGVudGlhbHNJbnN0YWxsQ29tbWFuZHMoXG4gIHVzYWdlOiBEb2NrZXJDcmVkZW50aWFsVXNhZ2UsXG4gIHJlZ2lzdHJpZXM/OiBEb2NrZXJDcmVkZW50aWFsW10sXG4gIG9zVHlwZT86IGVjMi5PcGVyYXRpbmdTeXN0ZW1UeXBlIHwgJ2JvdGgnKTogc3RyaW5nW10ge1xuXG4gIGNvbnN0IHJlbGV2YW50UmVnaXN0cmllcyA9IChyZWdpc3RyaWVzID8/IFtdKS5maWx0ZXIocmVnID0+IHJlZy5fYXBwbGljYWJsZUZvclVzYWdlKHVzYWdlKSk7XG4gIGlmICghcmVsZXZhbnRSZWdpc3RyaWVzIHx8IHJlbGV2YW50UmVnaXN0cmllcy5sZW5ndGggPT09IDApIHsgcmV0dXJuIFtdOyB9XG5cbiAgY29uc3QgZG9tYWluQ3JlZGVudGlhbHMgPSByZWxldmFudFJlZ2lzdHJpZXMucmVkdWNlKGZ1bmN0aW9uIChtYXA6IFJlY29yZDxzdHJpbmcsIGFueT4sIHJlZ2lzdHJ5KSB7XG4gICAgT2JqZWN0LmFzc2lnbihtYXAsIHJlZ2lzdHJ5Ll9yZW5kZXJDZGtBc3NldHNDb25maWcoKSk7XG4gICAgcmV0dXJuIG1hcDtcbiAgfSwge30pO1xuICBjb25zdCBjZGtBc3NldHNDb25maWdGaWxlID0ge1xuICAgIHZlcnNpb246ICcxLjAnLFxuICAgIGRvbWFpbkNyZWRlbnRpYWxzLFxuICB9O1xuXG4gIGNvbnN0IHdpbmRvd3NDb21tYW5kcyA9IFtcbiAgICAnbWtkaXIgJVVTRVJQUk9GSUxFJVxcXFwuY2RrJyxcbiAgICBgZWNobyAnJHtKU09OLnN0cmluZ2lmeShjZGtBc3NldHNDb25maWdGaWxlKX0nID4gJVVTRVJQUk9GSUxFJVxcXFwuY2RrXFxcXGNkay1kb2NrZXItY3JlZHMuanNvbmAsXG4gIF07XG5cbiAgY29uc3QgbGludXhDb21tYW5kcyA9IFtcbiAgICAnbWtkaXIgJEhPTUUvLmNkaycsXG4gICAgYGVjaG8gJyR7SlNPTi5zdHJpbmdpZnkoY2RrQXNzZXRzQ29uZmlnRmlsZSl9JyA+ICRIT01FLy5jZGsvY2RrLWRvY2tlci1jcmVkcy5qc29uYCxcbiAgXTtcblxuICBpZiAob3NUeXBlID09PSAnYm90aCcpIHtcbiAgICByZXR1cm4gW1xuICAgICAgLy8gVGhlc2UgdGFncyBhcmUgbWFnaWMgYW5kIHdpbGwgYmUgc3RyaXBwZWQgd2hlbiByZW5kZXJpbmcgdGhlIHByb2plY3RcbiAgICAgIC4uLndpbmRvd3NDb21tYW5kcy5tYXAoYyA9PiBgIVdJTkRPV1MhJHtjfWApLFxuICAgICAgLi4ubGludXhDb21tYW5kcy5tYXAoYyA9PiBgIUxJTlVYISR7Y31gKSxcbiAgICBdO1xuICB9IGVsc2UgaWYgKG9zVHlwZSA9PT0gZWMyLk9wZXJhdGluZ1N5c3RlbVR5cGUuV0lORE9XUykge1xuICAgIHJldHVybiB3aW5kb3dzQ29tbWFuZHM7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGxpbnV4Q29tbWFuZHM7XG4gIH1cbn1cbiJdfQ==