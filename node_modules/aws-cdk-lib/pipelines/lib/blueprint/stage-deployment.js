"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StageDeployment = void 0;
const jsiiDeprecationWarnings = require("../../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const cloud_assembly_internals_1 = require("../private/cloud-assembly-internals");
const construct_internals_1 = require("../private/construct-internals");
const stack_deployment_1 = require("./stack-deployment");
/**
 * Deployment of a single `Stage`.
 *
 * A `Stage` consists of one or more `Stacks`, which will be
 * deployed in dependency order.
 *
 * @stability stable
 */
class StageDeployment {
    constructor(
    /** The stacks deployed in this stage */
    stacks, props = {}) {
        var _b, _c, _d, _e;
        this.stacks = stacks;
        this.stageName = (_b = props.stageName) !== null && _b !== void 0 ? _b : '';
        this.pre = (_c = props.pre) !== null && _c !== void 0 ? _c : [];
        this.post = (_d = props.post) !== null && _d !== void 0 ? _d : [];
        this.stackSteps = (_e = props.stackSteps) !== null && _e !== void 0 ? _e : [];
    }
    /**
     * Create a new `StageDeployment` from a `Stage`.
     *
     * Synthesizes the target stage, and deployes the stacks found inside
     * in dependency order.
     *
     * @stability stable
     */
    static fromStage(stage, props = {}) {
        var _b, _c, _d;
        jsiiDeprecationWarnings.aws_cdk_lib_Stage(stage);
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_StageDeploymentProps(props);
        const assembly = construct_internals_1.pipelineSynth(stage);
        if (assembly.stacks.length === 0) {
            // If we don't check here, a more puzzling "stage contains no actions"
            // error will be thrown come deployment time.
            throw new Error(`The given Stage construct ('${stage.node.path}') should contain at least one Stack`);
        }
        const stepFromArtifact = new Map();
        for (const artifact of assembly.stacks) {
            const step = stack_deployment_1.StackDeployment.fromArtifact(artifact);
            stepFromArtifact.set(artifact, step);
        }
        if (props.stackSteps) {
            for (const stackstep of props.stackSteps) {
                const stackArtifact = assembly.getStackArtifact(stackstep.stack.artifactId);
                const thisStep = stepFromArtifact.get(stackArtifact);
                if (!thisStep) {
                    throw new Error('Logic error: we just added a step for this artifact but it disappeared.');
                }
                thisStep.addStackSteps((_b = stackstep.pre) !== null && _b !== void 0 ? _b : [], (_c = stackstep.changeSet) !== null && _c !== void 0 ? _c : [], (_d = stackstep.post) !== null && _d !== void 0 ? _d : []);
            }
        }
        for (const artifact of assembly.stacks) {
            const thisStep = stepFromArtifact.get(artifact);
            if (!thisStep) {
                throw new Error('Logic error: we just added a step for this artifact but it disappeared.');
            }
            const stackDependencies = artifact.dependencies.filter(cloud_assembly_internals_1.isStackArtifact);
            for (const dep of stackDependencies) {
                const depStep = stepFromArtifact.get(dep);
                if (!depStep) {
                    throw new Error(`Stack '${artifact.id}' depends on stack not found in same Stage: '${dep.id}'`);
                }
                thisStep.addStackDependency(depStep);
            }
        }
        return new StageDeployment(Array.from(stepFromArtifact.values()), {
            stageName: stage.stageName,
            ...props,
        });
    }
    /**
     * Add an additional step to run before any of the stacks in this stage.
     *
     * @stability stable
     */
    addPre(...steps) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_Step(steps);
        this.pre.push(...steps);
    }
    /**
     * Add an additional step to run after all of the stacks in this stage.
     *
     * @stability stable
     */
    addPost(...steps) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_Step(steps);
        this.post.push(...steps);
    }
}
exports.StageDeployment = StageDeployment;
_a = JSII_RTTI_SYMBOL_1;
StageDeployment[_a] = { fqn: "aws-cdk-lib.pipelines.StageDeployment", version: "2.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhZ2UtZGVwbG95bWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YWdlLWRlcGxveW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUEsa0ZBQXNFO0FBQ3RFLHdFQUErRDtBQUMvRCx5REFBcUQ7Ozs7Ozs7OztBQW1CckQsTUFBYSxlQUFlO0lBNEQxQjtJQUNFLHdDQUF3QztJQUN4QixNQUF5QixFQUFFLFFBQThCLEVBQUU7O1FBQTNELFdBQU0sR0FBTixNQUFNLENBQW1CO1FBQ3pDLElBQUksQ0FBQyxTQUFTLFNBQUcsS0FBSyxDQUFDLFNBQVMsbUNBQUksRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxHQUFHLFNBQUcsS0FBSyxDQUFDLEdBQUcsbUNBQUksRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxJQUFJLFNBQUcsS0FBSyxDQUFDLElBQUksbUNBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLFNBQUcsS0FBSyxDQUFDLFVBQVUsbUNBQUksRUFBRSxDQUFDO0tBQzFDOzs7Ozs7Ozs7SUFqRU0sTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFnQixFQUFFLFFBQThCLEVBQUU7Ozs7UUFDeEUsTUFBTSxRQUFRLEdBQUcsbUNBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNoQyxzRUFBc0U7WUFDdEUsNkNBQTZDO1lBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxzQ0FBc0MsQ0FBQyxDQUFDO1NBQ3ZHO1FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBZ0QsQ0FBQztRQUNqRixLQUFLLE1BQU0sUUFBUSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEdBQUcsa0NBQWUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDcEQsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN0QztRQUNELElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUNwQixLQUFLLE1BQU0sU0FBUyxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUU7Z0JBQ3hDLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUM1RSxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyx5RUFBeUUsQ0FBQyxDQUFDO2lCQUM1RjtnQkFDRCxRQUFRLENBQUMsYUFBYSxPQUFDLFNBQVMsQ0FBQyxHQUFHLG1DQUFJLEVBQUUsUUFBRSxTQUFTLENBQUMsU0FBUyxtQ0FBSSxFQUFFLFFBQUUsU0FBUyxDQUFDLElBQUksbUNBQUksRUFBRSxDQUFDLENBQUM7YUFDOUY7U0FDRjtRQUVELEtBQUssTUFBTSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUN0QyxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDYixNQUFNLElBQUksS0FBSyxDQUFDLHlFQUF5RSxDQUFDLENBQUM7YUFDNUY7WUFFRCxNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLDBDQUFlLENBQUMsQ0FBQztZQUN4RSxLQUFLLE1BQU0sR0FBRyxJQUFJLGlCQUFpQixFQUFFO2dCQUNuQyxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzFDLElBQUksQ0FBQyxPQUFPLEVBQUU7b0JBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLFFBQVEsQ0FBQyxFQUFFLGdEQUFnRCxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztpQkFDakc7Z0JBQ0QsUUFBUSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3RDO1NBQ0Y7UUFFRCxPQUFPLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRTtZQUNoRSxTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVM7WUFDMUIsR0FBRyxLQUFLO1NBQ1QsQ0FBQyxDQUFDO0tBQ0o7Ozs7OztJQXdCTSxNQUFNLENBQUMsR0FBRyxLQUFhOztRQUM1QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0tBQ3pCOzs7Ozs7SUFHTSxPQUFPLENBQUMsR0FBRyxLQUFhOztRQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0tBQzFCOztBQTdFSCwwQ0E4RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QgfSBmcm9tICcuLi8uLi8uLi9jeC1hcGknO1xuaW1wb3J0IHsgaXNTdGFja0FydGlmYWN0IH0gZnJvbSAnLi4vcHJpdmF0ZS9jbG91ZC1hc3NlbWJseS1pbnRlcm5hbHMnO1xuaW1wb3J0IHsgcGlwZWxpbmVTeW50aCB9IGZyb20gJy4uL3ByaXZhdGUvY29uc3RydWN0LWludGVybmFscyc7XG5pbXBvcnQgeyBTdGFja0RlcGxveW1lbnQgfSBmcm9tICcuL3N0YWNrLWRlcGxveW1lbnQnO1xuaW1wb3J0IHsgU3RhY2tTdGVwcywgU3RlcCB9IGZyb20gJy4vc3RlcCc7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGludGVyZmFjZSBTdGFnZURlcGxveW1lbnRQcm9wcyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgc3RhZ2VOYW1lPzogc3RyaW5nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBwcmU/OiBTdGVwW107XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgcG9zdD86IFN0ZXBbXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBzdGFja1N0ZXBzPzogU3RhY2tTdGVwc1tdO1xufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBjbGFzcyBTdGFnZURlcGxveW1lbnQge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyBzdGF0aWMgZnJvbVN0YWdlKHN0YWdlOiBjZGsuU3RhZ2UsIHByb3BzOiBTdGFnZURlcGxveW1lbnRQcm9wcyA9IHt9KSB7XG4gICAgY29uc3QgYXNzZW1ibHkgPSBwaXBlbGluZVN5bnRoKHN0YWdlKTtcbiAgICBpZiAoYXNzZW1ibHkuc3RhY2tzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gSWYgd2UgZG9uJ3QgY2hlY2sgaGVyZSwgYSBtb3JlIHB1enpsaW5nIFwic3RhZ2UgY29udGFpbnMgbm8gYWN0aW9uc1wiXG4gICAgICAvLyBlcnJvciB3aWxsIGJlIHRocm93biBjb21lIGRlcGxveW1lbnQgdGltZS5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGdpdmVuIFN0YWdlIGNvbnN0cnVjdCAoJyR7c3RhZ2Uubm9kZS5wYXRofScpIHNob3VsZCBjb250YWluIGF0IGxlYXN0IG9uZSBTdGFja2ApO1xuICAgIH1cblxuICAgIGNvbnN0IHN0ZXBGcm9tQXJ0aWZhY3QgPSBuZXcgTWFwPENsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCwgU3RhY2tEZXBsb3ltZW50PigpO1xuICAgIGZvciAoY29uc3QgYXJ0aWZhY3Qgb2YgYXNzZW1ibHkuc3RhY2tzKSB7XG4gICAgICBjb25zdCBzdGVwID0gU3RhY2tEZXBsb3ltZW50LmZyb21BcnRpZmFjdChhcnRpZmFjdCk7XG4gICAgICBzdGVwRnJvbUFydGlmYWN0LnNldChhcnRpZmFjdCwgc3RlcCk7XG4gICAgfVxuICAgIGlmIChwcm9wcy5zdGFja1N0ZXBzKSB7XG4gICAgICBmb3IgKGNvbnN0IHN0YWNrc3RlcCBvZiBwcm9wcy5zdGFja1N0ZXBzKSB7XG4gICAgICAgIGNvbnN0IHN0YWNrQXJ0aWZhY3QgPSBhc3NlbWJseS5nZXRTdGFja0FydGlmYWN0KHN0YWNrc3RlcC5zdGFjay5hcnRpZmFjdElkKTtcbiAgICAgICAgY29uc3QgdGhpc1N0ZXAgPSBzdGVwRnJvbUFydGlmYWN0LmdldChzdGFja0FydGlmYWN0KTtcbiAgICAgICAgaWYgKCF0aGlzU3RlcCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTG9naWMgZXJyb3I6IHdlIGp1c3QgYWRkZWQgYSBzdGVwIGZvciB0aGlzIGFydGlmYWN0IGJ1dCBpdCBkaXNhcHBlYXJlZC4nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzU3RlcC5hZGRTdGFja1N0ZXBzKHN0YWNrc3RlcC5wcmUgPz8gW10sIHN0YWNrc3RlcC5jaGFuZ2VTZXQgPz8gW10sIHN0YWNrc3RlcC5wb3N0ID8/IFtdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGFydGlmYWN0IG9mIGFzc2VtYmx5LnN0YWNrcykge1xuICAgICAgY29uc3QgdGhpc1N0ZXAgPSBzdGVwRnJvbUFydGlmYWN0LmdldChhcnRpZmFjdCk7XG4gICAgICBpZiAoIXRoaXNTdGVwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTG9naWMgZXJyb3I6IHdlIGp1c3QgYWRkZWQgYSBzdGVwIGZvciB0aGlzIGFydGlmYWN0IGJ1dCBpdCBkaXNhcHBlYXJlZC4nKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3RhY2tEZXBlbmRlbmNpZXMgPSBhcnRpZmFjdC5kZXBlbmRlbmNpZXMuZmlsdGVyKGlzU3RhY2tBcnRpZmFjdCk7XG4gICAgICBmb3IgKGNvbnN0IGRlcCBvZiBzdGFja0RlcGVuZGVuY2llcykge1xuICAgICAgICBjb25zdCBkZXBTdGVwID0gc3RlcEZyb21BcnRpZmFjdC5nZXQoZGVwKTtcbiAgICAgICAgaWYgKCFkZXBTdGVwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGFjayAnJHthcnRpZmFjdC5pZH0nIGRlcGVuZHMgb24gc3RhY2sgbm90IGZvdW5kIGluIHNhbWUgU3RhZ2U6ICcke2RlcC5pZH0nYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpc1N0ZXAuYWRkU3RhY2tEZXBlbmRlbmN5KGRlcFN0ZXApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgU3RhZ2VEZXBsb3ltZW50KEFycmF5LmZyb20oc3RlcEZyb21BcnRpZmFjdC52YWx1ZXMoKSksIHtcbiAgICAgIHN0YWdlTmFtZTogc3RhZ2Uuc3RhZ2VOYW1lLFxuICAgICAgLi4ucHJvcHMsXG4gICAgfSk7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHJlYWRvbmx5IHN0YWdlTmFtZTogc3RyaW5nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHJlYWRvbmx5IHByZTogU3RlcFtdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgcmVhZG9ubHkgcG9zdDogU3RlcFtdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHJlYWRvbmx5IHN0YWNrU3RlcHM6IFN0YWNrU3RlcHNbXTtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKFxuICAgIC8qKiBUaGUgc3RhY2tzIGRlcGxveWVkIGluIHRoaXMgc3RhZ2UgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgc3RhY2tzOiBTdGFja0RlcGxveW1lbnRbXSwgcHJvcHM6IFN0YWdlRGVwbG95bWVudFByb3BzID0ge30pIHtcbiAgICB0aGlzLnN0YWdlTmFtZSA9IHByb3BzLnN0YWdlTmFtZSA/PyAnJztcbiAgICB0aGlzLnByZSA9IHByb3BzLnByZSA/PyBbXTtcbiAgICB0aGlzLnBvc3QgPSBwcm9wcy5wb3N0ID8/IFtdO1xuICAgIHRoaXMuc3RhY2tTdGVwcyA9IHByb3BzLnN0YWNrU3RlcHMgPz8gW107XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgYWRkUHJlKC4uLnN0ZXBzOiBTdGVwW10pIHtcbiAgICB0aGlzLnByZS5wdXNoKC4uLnN0ZXBzKTtcbiAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIGFkZFBvc3QoLi4uc3RlcHM6IFN0ZXBbXSkge1xuICAgIHRoaXMucG9zdC5wdXNoKC4uLnN0ZXBzKTtcbiAgfVxufSJdfQ==