"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StackOutputReference = exports.ShellStep = void 0;
const jsiiDeprecationWarnings = require("../../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const core_1 = require("../../../core");
const javascript_1 = require("../private/javascript");
const file_set_1 = require("./file-set");
const step_1 = require("./step");
/**
 * Run shell script commands in the pipeline.
 *
 * @stability stable
 */
class ShellStep extends step_1.Step {
    /**
     * @stability stable
     */
    constructor(id, props) {
        var _c, _d, _e, _f;
        super(id);
        /**
         * Input FileSets.
         *
         * A list of `(FileSet, directory)` pairs, which are a copy of the
         * input properties. This list should not be modified directly.
         *
         * @stability stable
         */
        this.inputs = [];
        /**
         * Output FileSets.
         *
         * A list of `(FileSet, directory)` pairs, which are a copy of the
         * input properties. This list should not be modified directly.
         *
         * @stability stable
         */
        this.outputs = [];
        this._additionalOutputs = {};
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_ShellStepProps(props);
        this.commands = props.commands;
        this.installCommands = (_c = props.installCommands) !== null && _c !== void 0 ? _c : [];
        this.env = (_d = props.env) !== null && _d !== void 0 ? _d : {};
        this.envFromCfnOutputs = javascript_1.mapValues((_e = props.envFromCfnOutputs) !== null && _e !== void 0 ? _e : {}, StackOutputReference.fromCfnOutput);
        // Inputs
        if (props.input) {
            const fileSet = props.input.primaryOutput;
            if (!fileSet) {
                throw new Error(`'${id}': primary input should be a step that produces a file set, got ${props.input}`);
            }
            this.addDependencyFileSet(fileSet);
            this.inputs.push({ directory: '.', fileSet });
        }
        for (const [directory, step] of Object.entries((_f = props.additionalInputs) !== null && _f !== void 0 ? _f : {})) {
            if (directory === '.') {
                throw new Error(`'${id}': input for directory '.' should be passed via 'input' property`);
            }
            const fileSet = step.primaryOutput;
            if (!fileSet) {
                throw new Error(`'${id}': additionalInput for directory '${directory}' should be a step that produces a file set, got ${step}`);
            }
            this.addDependencyFileSet(fileSet);
            this.inputs.push({ directory, fileSet });
        }
        // Outputs
        if (props.primaryOutputDirectory) {
            this._primaryOutputDirectory = props.primaryOutputDirectory;
            const fileSet = new file_set_1.FileSet('Output', this);
            this.configurePrimaryOutput(fileSet);
            this.outputs.push({ directory: props.primaryOutputDirectory, fileSet });
        }
    }
    /**
     * Configure the given output directory as primary output.
     *
     * If no primary output has been configured yet, this directory
     * will become the primary output of this ShellStep, otherwise this
     * method will throw if the given directory is different than the
     * currently configured primary output directory.
     *
     * @stability stable
     */
    primaryOutputDirectory(directory) {
        if (this._primaryOutputDirectory !== undefined) {
            if (this._primaryOutputDirectory !== directory) {
                throw new Error(`${this}: primaryOutputDirectory is '${this._primaryOutputDirectory}', cannot be changed to '${directory}'`);
            }
            return this.primaryOutput;
        }
        this._primaryOutputDirectory = directory;
        const fileSet = new file_set_1.FileSet('Output', this);
        this.configurePrimaryOutput(fileSet);
        this.outputs.push({ directory: directory, fileSet });
        return fileSet;
    }
    /**
     * Add an additional output FileSet based on a directory.
     *
     * After running the script, the contents of the given directory
     * will be exported as a `FileSet`. Use the `FileSet` as the
     * input to another step.
     *
     * Multiple calls with the exact same directory name string (not normalized)
     * will return the same FileSet.
     *
     * @stability stable
     */
    addOutputDirectory(directory) {
        let fileSet = this._additionalOutputs[directory];
        if (!fileSet) {
            fileSet = new file_set_1.FileSet(directory, this);
            this._additionalOutputs[directory] = fileSet;
            this.outputs.push({ directory, fileSet });
        }
        return fileSet;
    }
}
exports.ShellStep = ShellStep;
_a = JSII_RTTI_SYMBOL_1;
ShellStep[_a] = { fqn: "aws-cdk-lib.pipelines.ShellStep", version: "2.0.0" };
/**
 * A Reference to a Stack Output.
 *
 * @stability stable
 */
class StackOutputReference {
    constructor(
    /** A human-readable description of the producing stack */
    stackDescription, 
    /** Artifact id of the producing stack */
    stackArtifactId, 
    /** Output name of the producing stack */
    outputName) {
        this.stackDescription = stackDescription;
        this.stackArtifactId = stackArtifactId;
        this.outputName = outputName;
    }
    /**
     * Create a StackOutputReference that references the given CfnOutput.
     *
     * @stability stable
     */
    static fromCfnOutput(output) {
        jsiiDeprecationWarnings.aws_cdk_lib_CfnOutput(output);
        const stack = core_1.Stack.of(output);
        return new StackOutputReference(stack.node.path, stack.artifactId, stack.resolve(output.logicalId));
    }
    /**
     * Whether or not this stack output is being produced by the given Stack deployment.
     *
     * @stability stable
     */
    isProducedBy(stack) {
        jsiiDeprecationWarnings.aws_cdk_lib_pipelines_StackDeployment(stack);
        return stack.stackArtifactId === this.stackArtifactId;
    }
}
exports.StackOutputReference = StackOutputReference;
_b = JSII_RTTI_SYMBOL_1;
StackOutputReference[_b] = { fqn: "aws-cdk-lib.pipelines.StackOutputReference", version: "2.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwtc3RlcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNoZWxsLXN0ZXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0NBQWlEO0FBQ2pELHNEQUFrRDtBQUNsRCx5Q0FBdUQ7QUFFdkQsaUNBQThCOzs7Ozs7QUE0QjlCLE1BQWEsU0FBVSxTQUFRLFdBQUk7Ozs7SUF1QmpDLFlBQVksRUFBVSxFQUFFLEtBQXFCOztRQUMzQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7Ozs7Ozs7OztRQVZJLFdBQU0sR0FBc0IsRUFBRSxDQUFDOzs7Ozs7Ozs7UUFHL0IsWUFBTyxHQUFzQixFQUFFLENBQUM7UUFFL0IsdUJBQWtCLEdBQTRCLEVBQUUsQ0FBQzs7UUFPaEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxlQUFlLFNBQUcsS0FBSyxDQUFDLGVBQWUsbUNBQUksRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxHQUFHLFNBQUcsS0FBSyxDQUFDLEdBQUcsbUNBQUksRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxzQkFBUyxPQUFDLEtBQUssQ0FBQyxpQkFBaUIsbUNBQUksRUFBRSxFQUFFLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXRHLFNBQVM7UUFDVCxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUU7WUFDZixNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQztZQUMxQyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLG1FQUFtRSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQzthQUN6RztZQUNELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFB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LENBQVE7UUFFeEIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtLQUNuQzs7Ozs7O0lBWk0sTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFpQjs7UUFDM0MsTUFBTSxLQUFLLEdBQUcsWUFBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixPQUFPLElBQUksb0JBQW9CLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0tBQ3JHOzs7Ozs7SUFZTSxZQUFZLENBQUMsS0FBc0I7O1FBQ3hDLE9BQU8sS0FBSyxDQUFDLGVBQWUsS0FBSyxJQUFJLENBQUMsZUFBZSxDQUFDO0tBQ3ZEOztBQW5CSCxvREFvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5PdXRwdXQsIFN0YWNrIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBtYXBWYWx1ZXMgfSBmcm9tICcuLi9wcml2YXRlL2phdmFzY3JpcHQnO1xuaW1wb3J0IHsgRmlsZVNldCwgSUZpbGVTZXRQcm9kdWNlciB9IGZyb20gJy4vZmlsZS1zZXQnO1xuaW1wb3J0IHsgU3RhY2tEZXBsb3ltZW50IH0gZnJvbSAnLi9zdGFjay1kZXBsb3ltZW50JztcbmltcG9ydCB7IFN0ZXAgfSBmcm9tICcuL3N0ZXAnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGludGVyZmFjZSBTaGVsbFN0ZXBQcm9wcyB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBjb21tYW5kczogc3RyaW5nW107XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBpbnN0YWxsQ29tbWFuZHM/OiBzdHJpbmdbXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBlbnY/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGVudkZyb21DZm5PdXRwdXRzPzogUmVjb3JkPHN0cmluZywgQ2ZuT3V0cHV0PjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBpbnB1dD86IElGaWxlU2V0UHJvZHVjZXI7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGFkZGl0aW9uYWxJbnB1dHM/OiBSZWNvcmQ8c3RyaW5nLCBJRmlsZVNldFByb2R1Y2VyPjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IHByaW1hcnlPdXRwdXREaXJlY3Rvcnk/OiBzdHJpbmc7XG5cbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGNsYXNzIFNoZWxsU3RlcCBleHRlbmRzIFN0ZXAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHJlYWRvbmx5IGNvbW1hbmRzOiBzdHJpbmdbXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyByZWFkb25seSBpbnN0YWxsQ29tbWFuZHM6IHN0cmluZ1tdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyByZWFkb25seSBlbnY6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgcmVhZG9ubHkgZW52RnJvbUNmbk91dHB1dHM6IFJlY29yZDxzdHJpbmcsIFN0YWNrT3V0cHV0UmVmZXJlbmNlPjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHB1YmxpYyByZWFkb25seSBpbnB1dHM6IEZpbGVTZXRMb2NhdGlvbltdID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHJlYWRvbmx5IG91dHB1dHM6IEZpbGVTZXRMb2NhdGlvbltdID0gW107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfYWRkaXRpb25hbE91dHB1dHM6IFJlY29yZDxzdHJpbmcsIEZpbGVTZXQ+ID0ge307XG5cbiAgcHJpdmF0ZSBfcHJpbWFyeU91dHB1dERpcmVjdG9yeT86IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBwcm9wczogU2hlbGxTdGVwUHJvcHMpIHtcbiAgICBzdXBlcihpZCk7XG5cbiAgICB0aGlzLmNvbW1hbmRzID0gcHJvcHMuY29tbWFuZHM7XG4gICAgdGhpcy5pbnN0YWxsQ29tbWFuZHMgPSBwcm9wcy5pbnN0YWxsQ29tbWFuZHMgPz8gW107XG4gICAgdGhpcy5lbnYgPSBwcm9wcy5lbnYgPz8ge307XG4gICAgdGhpcy5lbnZGcm9tQ2ZuT3V0cHV0cyA9IG1hcFZhbHVlcyhwcm9wcy5lbnZGcm9tQ2ZuT3V0cHV0cyA/PyB7fSwgU3RhY2tPdXRwdXRSZWZlcmVuY2UuZnJvbUNmbk91dHB1dCk7XG5cbiAgICAvLyBJbnB1dHNcbiAgICBpZiAocHJvcHMuaW5wdXQpIHtcbiAgICAgIGNvbnN0IGZpbGVTZXQgPSBwcm9wcy5pbnB1dC5wcmltYXJ5T3V0cHV0O1xuICAgICAgaWYgKCFmaWxlU2V0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7aWR9JzogcHJpbWFyeSBpbnB1dCBzaG91bGQgYmUgYSBzdGVwIHRoYXQgcHJvZHVjZXMgYSBmaWxlIHNldCwgZ290ICR7cHJvcHMuaW5wdXR9YCk7XG4gICAgICB9XG4gICAgICB0aGlzLmFkZERlcGVuZGVuY3lGaWxlU2V0KGZpbGVTZXQpO1xuICAgICAgdGhpcy5pbnB1dHMucHVzaCh7IGRpcmVjdG9yeTogJy4nLCBmaWxlU2V0IH0pO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgW2RpcmVjdG9yeSwgc3RlcF0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMuYWRkaXRpb25hbElucHV0cyA/PyB7fSkpIHtcbiAgICAgIGlmIChkaXJlY3RvcnkgPT09ICcuJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2lkfSc6IGlucHV0IGZvciBkaXJlY3RvcnkgJy4nIHNob3VsZCBiZSBwYXNzZWQgdmlhICdpbnB1dCcgcHJvcGVydHlgKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmlsZVNldCA9IHN0ZXAucHJpbWFyeU91dHB1dDtcbiAgICAgIGlmICghZmlsZVNldCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2lkfSc6IGFkZGl0aW9uYWxJbnB1dCBmb3IgZGlyZWN0b3J5ICcke2RpcmVjdG9yeX0nIHNob3VsZCBiZSBhIHN0ZXAgdGhhdCBwcm9kdWNlcyBhIGZpbGUgc2V0LCBnb3QgJHtzdGVwfWApO1xuICAgICAgfVxuICAgICAgdGhpcy5hZGREZXBlbmRlbmN5RmlsZVNldChmaWxlU2V0KTtcbiAgICAgIHRoaXMuaW5wdXRzLnB1c2goeyBkaXJlY3RvcnksIGZpbGVTZXQgfSk7XG4gICAgfVxuXG4gICAgLy8gT3V0cHV0c1xuXG4gICAgaWYgKHByb3BzLnByaW1hcnlPdXRwdXREaXJlY3RvcnkpIHtcbiAgICAgIHRoaXMuX3ByaW1hcnlPdXRwdXREaXJlY3RvcnkgPSBwcm9wcy5wcmltYXJ5T3V0cHV0RGlyZWN0b3J5O1xuICAgICAgY29uc3QgZmlsZVNldCA9IG5ldyBGaWxlU2V0KCdPdXRwdXQnLCB0aGlzKTtcbiAgICAgIHRoaXMuY29uZmlndXJlUHJpbWFyeU91dHB1dChmaWxlU2V0KTtcbiAgICAgIHRoaXMub3V0cHV0cy5wdXNoKHsgZGlyZWN0b3J5OiBwcm9wcy5wcmltYXJ5T3V0cHV0RGlyZWN0b3J5LCBmaWxlU2V0IH0pO1xuICAgIH1cbiAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgcHJpbWFyeU91dHB1dERpcmVjdG9yeShkaXJlY3Rvcnk6IHN0cmluZyk6IEZpbGVTZXQge1xuICAgIGlmICh0aGlzLl9wcmltYXJ5T3V0cHV0RGlyZWN0b3J5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmICh0aGlzLl9wcmltYXJ5T3V0cHV0RGlyZWN0b3J5ICE9PSBkaXJlY3RvcnkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXN9OiBwcmltYXJ5T3V0cHV0RGlyZWN0b3J5IGlzICcke3RoaXMuX3ByaW1hcnlPdXRwdXREaXJlY3Rvcnl9JywgY2Fubm90IGJlIGNoYW5nZWQgdG8gJyR7ZGlyZWN0b3J5fSdgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeU91dHB1dCE7XG4gICAgfVxuXG4gICAgdGhpcy5fcHJpbWFyeU91dHB1dERpcmVjdG9yeSA9IGRpcmVjdG9yeTtcbiAgICBjb25zdCBmaWxlU2V0ID0gbmV3IEZpbGVTZXQoJ091dHB1dCcsIHRoaXMpO1xuICAgIHRoaXMuY29uZmlndXJlUHJpbWFyeU91dHB1dChmaWxlU2V0KTtcbiAgICB0aGlzLm91dHB1dHMucHVzaCh7IGRpcmVjdG9yeTogZGlyZWN0b3J5LCBmaWxlU2V0IH0pO1xuICAgIHJldHVybiBmaWxlU2V0O1xuICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIGFkZE91dHB1dERpcmVjdG9yeShkaXJlY3Rvcnk6IHN0cmluZyk6IEZpbGVTZXQge1xuICAgIGxldCBmaWxlU2V0ID0gdGhpcy5fYWRkaXRpb25hbE91dHB1dHNbZGlyZWN0b3J5XTtcbiAgICBpZiAoIWZpbGVTZXQpIHtcbiAgICAgIGZpbGVTZXQgPSBuZXcgRmlsZVNldChkaXJlY3RvcnksIHRoaXMpO1xuICAgICAgdGhpcy5fYWRkaXRpb25hbE91dHB1dHNbZGlyZWN0b3J5XSA9IGZpbGVTZXQ7XG4gICAgICB0aGlzLm91dHB1dHMucHVzaCh7IGRpcmVjdG9yeSwgZmlsZVNldCB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGZpbGVTZXQ7XG4gIH1cbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbmV4cG9ydCBpbnRlcmZhY2UgRmlsZVNldExvY2F0aW9uIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gIHJlYWRvbmx5IGRpcmVjdG9yeTogc3RyaW5nO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBmaWxlU2V0OiBGaWxlU2V0O1xufVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgY2xhc3MgU3RhY2tPdXRwdXRSZWZlcmVuY2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgc3RhdGljIGZyb21DZm5PdXRwdXQob3V0cHV0OiBDZm5PdXRwdXQpIHtcbiAgICBjb25zdCBzdGFjayA9IFN0YWNrLm9mKG91dHB1dCk7XG4gICAgcmV0dXJuIG5ldyBTdGFja091dHB1dFJlZmVyZW5jZShzdGFjay5ub2RlLnBhdGgsIHN0YWNrLmFydGlmYWN0SWQsIHN0YWNrLnJlc29sdmUob3V0cHV0LmxvZ2ljYWxJZCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihcbiAgICAvKiogQSBodW1hbi1yZWFkYWJsZSBkZXNjcmlwdGlvbiBvZiB0aGUgcHJvZHVjaW5nIHN0YWNrICovXG4gICAgcHVibGljIHJlYWRvbmx5IHN0YWNrRGVzY3JpcHRpb246IHN0cmluZyxcbiAgICAvKiogQXJ0aWZhY3QgaWQgb2YgdGhlIHByb2R1Y2luZyBzdGFjayAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RhY2tBcnRpZmFjdElkOiBzdHJpbmcsXG4gICAgLyoqIE91dHB1dCBuYW1lIG9mIHRoZSBwcm9kdWNpbmcgc3RhY2sgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgb3V0cHV0TmFtZTogc3RyaW5nKSB7XG4gIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgaXNQcm9kdWNlZEJ5KHN0YWNrOiBTdGFja0RlcGxveW1lbnQpIHtcbiAgICByZXR1cm4gc3RhY2suc3RhY2tBcnRpZmFjdElkID09PSB0aGlzLnN0YWNrQXJ0aWZhY3RJZDtcbiAgfVxufSJdfQ==