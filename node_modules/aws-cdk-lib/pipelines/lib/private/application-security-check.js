"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationSecurityCheck = void 0;
const path = require("path");
const codebuild = require("../../../aws-codebuild");
const iam = require("../../../aws-iam");
const lambda = require("../../../aws-lambda");
const core_1 = require("../../../core");
const constructs_1 = require("constructs");
/**
 * A construct containing both the Lambda and CodeBuild Project
 * needed to conduct a security check on any given application stage.
 *
 * The Lambda acts as an auto approving mechanism that should only be
 * triggered when the CodeBuild Project registers no security changes.
 *
 * The CodeBuild Project runs a security diff on the application stage,
 * and exports the link to the console of the project.
 */
class ApplicationSecurityCheck extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        core_1.Tags.of(props.codePipeline).add('SECURITY_CHECK', 'ALLOW_APPROVE', {
            includeResourceTypes: ['AWS::CodePipeline::Pipeline'],
        });
        this.preApproveLambda = new lambda.Function(this, 'CDKPipelinesAutoApprove', {
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_12_X,
            code: lambda.Code.fromAsset(path.resolve(__dirname, 'approve-lambda')),
            timeout: core_1.Duration.minutes(5),
        });
        this.preApproveLambda.addToRolePolicy(new iam.PolicyStatement({
            actions: ['codepipeline:GetPipelineState', 'codepipeline:PutApprovalResult'],
            conditions: {
                StringEquals: {
                    'aws:ResourceTag/SECURITY_CHECK': 'ALLOW_APPROVE',
                },
            },
            resources: ['*'],
        }));
        const invokeLambda = 'aws lambda invoke' +
            ` --function-name ${this.preApproveLambda.functionName}` +
            ' --invocation-type Event' +
            ' --payload "$payload"' +
            ' lambda.out';
        const message = [
            'An upcoming change would broaden security changes in $PIPELINE_NAME.',
            'Review and approve the changes in CodePipeline to proceed with the deployment.',
            '',
            'Review the changes in CodeBuild:',
            '',
            '$LINK',
            '',
            'Approve the changes in CodePipeline (stage $STAGE_NAME, action $ACTION_NAME):',
            '',
            '$PIPELINE_LINK',
        ];
        const publishNotification = 'aws sns publish' +
            ' --topic-arn $NOTIFICATION_ARN' +
            ' --subject "$NOTIFICATION_SUBJECT"' +
            ` --message "${message.join('\n')}"`;
        this.cdkDiffProject = new codebuild.Project(this, 'CDKSecurityCheck', {
            buildSpec: codebuild.BuildSpec.fromObject({
                version: 0.2,
                phases: {
                    build: {
                        commands: [
                            'npm install -g aws-cdk',
                            // $CODEBUILD_INITIATOR will always be Code Pipeline and in the form of:
                            // "codepipeline/example-pipeline-name-Xxx"
                            'export PIPELINE_NAME="$(node -pe \'`${process.env.CODEBUILD_INITIATOR}`.split("/")[1]\')"',
                            'payload="$(node -pe \'JSON.stringify({ "PipelineName": process.env.PIPELINE_NAME, "StageName": process.env.STAGE_NAME, "ActionName": process.env.ACTION_NAME })\' )"',
                            // ARN: "arn:aws:codebuild:$region:$account_id:build/$project_name:$project_execution_id$"
                            'ARN=$CODEBUILD_BUILD_ARN',
                            'REGION="$(node -pe \'`${process.env.ARN}`.split(":")[3]\')"',
                            'ACCOUNT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[4]\')"',
                            'PROJECT_NAME="$(node -pe \'`${process.env.ARN}`.split(":")[5].split("/")[1]\')"',
                            'PROJECT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[6]\')"',
                            // Manual Approval adds 'http/https' to the resolved link
                            'export LINK="https://$REGION.console.aws.amazon.com/codesuite/codebuild/$ACCOUNT_ID/projects/$PROJECT_NAME/build/$PROJECT_NAME:$PROJECT_ID/?region=$REGION"',
                            'export PIPELINE_LINK="https://$REGION.console.aws.amazon.com/codesuite/codepipeline/pipelines/$PIPELINE_NAME/view?region=$REGION"',
                            // Run invoke only if cdk diff passes (returns exit code 0)
                            // 0 -> true, 1 -> false
                            ifElse({
                                condition: 'cdk diff -a . --security-only --fail $STAGE_PATH/\\*',
                                thenStatements: [
                                    invokeLambda,
                                    'export MESSAGE="No security-impacting changes detected."',
                                ],
                                elseStatements: [
                                    `[ -z "\${NOTIFICATION_ARN}" ] || ${publishNotification}`,
                                    'export MESSAGE="Deployment would make security-impacting changes. Click the link below to inspect them, then click Approve if all changes are expected."',
                                ],
                            }),
                        ],
                    },
                },
                env: {
                    'exported-variables': [
                        'LINK',
                        'MESSAGE',
                    ],
                },
            }),
        });
        // this is needed to check the status the stacks when doing `cdk diff`
        this.cdkDiffProject.addToRolePolicy(new iam.PolicyStatement({
            actions: ['sts:AssumeRole'],
            resources: ['*'],
            conditions: {
                'ForAnyValue:StringEquals': {
                    'iam:ResourceTag/aws-cdk:bootstrap-role': ['deploy'],
                },
            },
        }));
        this.preApproveLambda.grantInvoke(this.cdkDiffProject);
    }
}
exports.ApplicationSecurityCheck = ApplicationSecurityCheck;
const ifElse = ({ condition, thenStatements, elseStatements }) => {
    let statement = thenStatements.reduce((acc, ifTrue) => {
        return `${acc} ${ifTrue};`;
    }, `if ${condition}; then`);
    if (elseStatements) {
        statement = elseStatements.reduce((acc, ifFalse) => {
            return `${acc} ${ifFalse};`;
        }, `${statement} else`);
    }
    return `${statement} fi`;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tc2VjdXJpdHktY2hlY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi1zZWN1cml0eS1jaGVjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBNkI7QUFDN0Isb0RBQW9EO0FBRXBELHdDQUF3QztBQUN4Qyw4Q0FBOEM7QUFDOUMsd0NBQStDO0FBQy9DLDJDQUF1QztBQWN2Qzs7Ozs7Ozs7O0dBU0c7QUFDSCxNQUFhLHdCQUF5QixTQUFRLHNCQUFTO0lBcUJyRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQW9DO1FBQzVFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsV0FBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGVBQWUsRUFBRTtZQUNqRSxvQkFBb0IsRUFBRSxDQUFDLDZCQUE2QixDQUFDO1NBQ3RELENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHlCQUF5QixFQUFFO1lBQzNFLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDdEUsT0FBTyxFQUFFLGVBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzdCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQzVELE9BQU8sRUFBRSxDQUFDLCtCQUErQixFQUFFLGdDQUFnQyxDQUFDO1lBQzVFLFVBQVUsRUFBRTtnQkFDVixZQUFZ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SUFBSSxPQUFPLEdBQUcsQ0FBQztRQUM5QixDQUFDLEVBQUUsR0FBRyxTQUFTLE9BQU8sQ0FBQyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxHQUFHLFNBQVMsS0FBSyxDQUFDO0FBQzNCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjb2RlYnVpbGQgZnJvbSAnLi4vLi4vLi4vYXdzLWNvZGVidWlsZCc7XG5pbXBvcnQgKiBhcyBjcCBmcm9tICcuLi8uLi8uLi9hd3MtY29kZXBpcGVsaW5lJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICcuLi8uLi8uLi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IER1cmF0aW9uLCBUYWdzIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBhbiBBcHBsaWNhdGlvblNlY3VyaXR5Q2hlY2tcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBsaWNhdGlvblNlY3VyaXR5Q2hlY2tQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgcGlwZWxpbmUgdGhhdCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgYXBwcm92ZWRcbiAgICpcbiAgICogV2lsbCBoYXZlIGEgdGFnIGFkZGVkIHRvIGl0LlxuICAgKi9cbiAgcmVhZG9ubHkgY29kZVBpcGVsaW5lOiBjcC5QaXBlbGluZTtcbn1cblxuLyoqXG4gKiBBIGNvbnN0cnVjdCBjb250YWluaW5nIGJvdGggdGhlIExhbWJkYSBhbmQgQ29kZUJ1aWxkIFByb2plY3RcbiAqIG5lZWRlZCB0byBjb25kdWN0IGEgc2VjdXJpdHkgY2hlY2sgb24gYW55IGdpdmVuIGFwcGxpY2F0aW9uIHN0YWdlLlxuICpcbiAqIFRoZSBMYW1iZGEgYWN0cyBhcyBhbiBhdXRvIGFwcHJvdmluZyBtZWNoYW5pc20gdGhhdCBzaG91bGQgb25seSBiZVxuICogdHJpZ2dlcmVkIHdoZW4gdGhlIENvZGVCdWlsZCBQcm9qZWN0IHJlZ2lzdGVycyBubyBzZWN1cml0eSBjaGFuZ2VzLlxuICpcbiAqIFRoZSBDb2RlQnVpbGQgUHJvamVjdCBydW5zIGEgc2VjdXJpdHkgZGlmZiBvbiB0aGUgYXBwbGljYXRpb24gc3RhZ2UsXG4gKiBhbmQgZXhwb3J0cyB0aGUgbGluayB0byB0aGUgY29uc29sZSBvZiB0aGUgcHJvamVjdC5cbiAqL1xuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uU2VjdXJpdHlDaGVjayBleHRlbmRzIENvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBBIGxhbWJkYSBmdW5jdGlvbiB0aGF0IGFwcHJvdmVzIGEgTWFudWFsIEFwcHJvdmFsIEFjdGlvbiwgZ2l2ZW5cbiAgICogdGhlIGZvbGxvd2luZyBwYXlsb2FkOlxuICAgKlxuICAgKiB7XG4gICAqICBcIlBpcGVsaW5lTmFtZVwiOiBbQ29kZVBpcGVsaW5lTmFtZV0sXG4gICAqICBcIlN0YWdlTmFtZVwiOiBbQ29kZVBpcGVsaW5lU3RhZ2VOYW1lXSxcbiAgICogIFwiQWN0aW9uTmFtZVwiOiBbTWFudWFsQXBwcm92YWxBY3Rpb25OYW1lXVxuICAgKiB9XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcHJlQXBwcm92ZUxhbWJkYTogbGFtYmRhLkZ1bmN0aW9uO1xuICAvKipcbiAgICogQSBDb2RlQnVpbGQgUHJvamVjdCB0aGF0IHJ1bnMgYSBzZWN1cml0eSBkaWZmIG9uIHRoZSBhcHBsaWNhdGlvbiBzdGFnZS5cbiAgICpcbiAgICogLSBJZiB0aGUgZGlmZiByZWdpc3RlcnMgbm8gc2VjdXJpdHkgY2hhbmdlcywgQ29kZUJ1aWxkIHdpbGwgaW52b2tlIHRoZVxuICAgKiAgIHByZS1hcHByb3ZhbCBsYW1iZGEgYW5kIGFwcHJvdmUgdGhlIE1hbnVhbEFwcHJvdmFsQWN0aW9uLlxuICAgKiAtIElmIGNoYW5nZXMgYXJlIGRldGVjdGVkLCBDb2RlQnVpbGQgd2lsbCBleGl0IGludG8gYSBNYW51YWxBcHByb3ZhbEFjdGlvblxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNka0RpZmZQcm9qZWN0OiBjb2RlYnVpbGQuUHJvamVjdDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXBwbGljYXRpb25TZWN1cml0eUNoZWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgVGFncy5vZihwcm9wcy5jb2RlUGlwZWxpbmUpLmFkZCgnU0VDVVJJVFlfQ0hFQ0snLCAnQUxMT1dfQVBQUk9WRScsIHtcbiAgICAgIGluY2x1ZGVSZXNvdXJjZVR5cGVzOiBbJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZSddLFxuICAgIH0pO1xuXG4gICAgdGhpcy5wcmVBcHByb3ZlTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnQ0RLUGlwZWxpbmVzQXV0b0FwcHJvdmUnLCB7XG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYXBwcm92ZS1sYW1iZGEnKSksXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDUpLFxuICAgIH0pO1xuXG4gICAgdGhpcy5wcmVBcHByb3ZlTGFtYmRhLmFkZFRvUm9sZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBhY3Rpb25zOiBbJ2NvZGVwaXBlbGluZTpHZXRQaXBlbGluZVN0YXRlJywgJ2NvZGVwaXBlbGluZTpQdXRBcHByb3ZhbFJlc3VsdCddLFxuICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAnYXdzOlJlc291cmNlVGFnL1NFQ1VSSVRZX0NIRUNLJzogJ0FMTE9XX0FQUFJPVkUnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgfSkpO1xuXG4gICAgY29uc3QgaW52b2tlTGFtYmRhID1cbiAgICAgICdhd3MgbGFtYmRhIGludm9rZScgK1xuICAgICAgYCAtLWZ1bmN0aW9uLW5hbWUgJHt0aGlzLnByZUFwcHJvdmVMYW1iZGEuZnVuY3Rpb25OYW1lfWAgK1xuICAgICAgJyAtLWludm9jYXRpb24tdHlwZSBFdmVudCcgK1xuICAgICAgJyAtLXBheWxvYWQgXCIkcGF5bG9hZFwiJyArXG4gICAgICAnIGxhbWJkYS5vdXQnO1xuXG4gICAgY29uc3QgbWVzc2FnZSA9IFtcbiAgICAgICdBbiB1cGNvbWluZyBjaGFuZ2Ugd291bGQgYnJvYWRlbiBzZWN1cml0eSBjaGFuZ2VzIGluICRQSVBFTElORV9OQU1FLicsXG4gICAgICAnUmV2aWV3IGFuZCBhcHByb3ZlIHRoZSBjaGFuZ2VzIGluIENvZGVQaXBlbGluZSB0byBwcm9jZWVkIHdpdGggdGhlIGRlcGxveW1lbnQuJyxcbiAgICAgICcnLFxuICAgICAgJ1JldmlldyB0aGUgY2hhbmdlcyBpbiBDb2RlQnVpbGQ6JyxcbiAgICAgICcnLFxuICAgICAgJyRMSU5LJyxcbiAgICAgICcnLFxuICAgICAgJ0FwcHJvdmUgdGhlIGNoYW5nZXMgaW4gQ29kZVBpcGVsaW5lIChzdGFnZSAkU1RBR0VfTkFNRSwgYWN0aW9uICRBQ1RJT05fTkFNRSk6JyxcbiAgICAgICcnLFxuICAgICAgJyRQSVBFTElORV9MSU5LJyxcbiAgICBdO1xuICAgIGNvbnN0IHB1Ymxpc2hOb3RpZmljYXRpb24gPVxuICAgICAgJ2F3cyBzbnMgcHVibGlzaCcgK1xuICAgICAgJyAtLXRvcGljLWFybiAkTk9USUZJQ0FUSU9OX0FSTicgK1xuICAgICAgJyAtLXN1YmplY3QgXCIkTk9USUZJQ0FUSU9OX1NVQkpFQ1RcIicgK1xuICAgICAgYCAtLW1lc3NhZ2UgXCIke21lc3NhZ2Uuam9pbignXFxuJyl9XCJgO1xuXG4gICAgdGhpcy5jZGtEaWZmUHJvamVjdCA9IG5ldyBjb2RlYnVpbGQuUHJvamVjdCh0aGlzLCAnQ0RLU2VjdXJpdHlDaGVjaycsIHtcbiAgICAgIGJ1aWxkU3BlYzogY29kZWJ1aWxkLkJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgICAgdmVyc2lvbjogMC4yLFxuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgY29tbWFuZHM6IFtcbiAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsIC1nIGF3cy1jZGsnLFxuICAgICAgICAgICAgICAvLyAkQ09ERUJVSUxEX0lOSVRJQVRPUiB3aWxsIGFsd2F5cyBiZSBDb2RlIFBpcGVsaW5lIGFuZCBpbiB0aGUgZm9ybSBvZjpcbiAgICAgICAgICAgICAgLy8gXCJjb2RlcGlwZWxpbmUvZXhhbXBsZS1waXBlbGluZS1uYW1lLVh4eFwiXG4gICAgICAgICAgICAgICdleHBvcnQgUElQRUxJTkVfTkFNRT1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQ09ERUJVSUxEX0lOSVRJQVRPUn1gLnNwbGl0KFwiL1wiKVsxXVxcJylcIicsXG4gICAgICAgICAgICAgICdwYXlsb2FkPVwiJChub2RlIC1wZSBcXCdKU09OLnN0cmluZ2lmeSh7IFwiUGlwZWxpbmVOYW1lXCI6IHByb2Nlc3MuZW52LlBJUEVMSU5FX05BTUUsIFwiU3RhZ2VOYW1lXCI6IHByb2Nlc3MuZW52LlNUQUdFX05BTUUsIFwiQWN0aW9uTmFtZVwiOiBwcm9jZXNzLmVudi5BQ1RJT05fTkFNRSB9KVxcJyApXCInLFxuICAgICAgICAgICAgICAvLyBBUk46IFwiYXJuOmF3czpjb2RlYnVpbGQ6JHJlZ2lvbjokYWNjb3VudF9pZDpidWlsZC8kcHJvamVjdF9uYW1lOiRwcm9qZWN0X2V4ZWN1dGlvbl9pZCRcIlxuICAgICAgICAgICAgICAnQVJOPSRDT0RFQlVJTERfQlVJTERfQVJOJyxcbiAgICAgICAgICAgICAgJ1JFR0lPTj1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzNdXFwnKVwiJyxcbiAgICAgICAgICAgICAgJ0FDQ09VTlRfSUQ9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs0XVxcJylcIicsXG4gICAgICAgICAgICAgICdQUk9KRUNUX05BTUU9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs1XS5zcGxpdChcIi9cIilbMV1cXCcpXCInLFxuICAgICAgICAgICAgICAnUFJPSkVDVF9JRD1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzZdXFwnKVwiJyxcbiAgICAgICAgICAgICAgLy8gTWFudWFsIEFwcHJvdmFsIGFkZHMgJ2h0dHAvaHR0cHMnIHRvIHRoZSByZXNvbHZlZCBsaW5rXG4gICAgICAgICAgICAgICdleHBvcnQgTElOSz1cImh0dHBzOi8vJFJFR0lPTi5jb25zb2xlLmF3cy5hbWF6b24uY29tL2NvZGVzdWl0ZS9jb2RlYnVpbGQvJEFDQ09VTlRfSUQvcHJvamVjdHMvJFBST0pFQ1RfTkFNRS9idWlsZC8kUFJPSkVDVF9OQU1FOiRQUk9KRUNUX0lELz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgJ2V4cG9ydCBQSVBFTElORV9MSU5LPVwiaHR0cHM6Ly8kUkVHSU9OLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vY29kZXN1aXRlL2NvZGVwaXBlbGluZS9waXBlbGluZXMvJFBJUEVMSU5FX05BTUUvdmlldz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgLy8gUnVuIGludm9rZSBvbmx5IGlmIGNkayBkaWZmIHBhc3NlcyAocmV0dXJucyBleGl0IGNvZGUgMClcbiAgICAgICAgICAgICAgLy8gMCAtPiB0cnVlLCAxIC0+IGZhbHNlXG4gICAgICAgICAgICAgIGlmRWxzZSh7XG4gICAgICAgICAgICAgICAgY29uZGl0aW9uOiAnY2RrIGRpZmYgLWEgLiAtLXNlY3VyaXR5LW9ubHkgLS1mYWlsICRTVEFHRV9QQVRIL1xcXFwqJyxcbiAgICAgICAgICAgICAgICB0aGVuU3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgICAgaW52b2tlTGFtYmRhLFxuICAgICAgICAgICAgICAgICAgJ2V4cG9ydCBNRVNTQUdFPVwiTm8gc2VjdXJpdHktaW1wYWN0aW5nIGNoYW5nZXMgZGV0ZWN0ZWQuXCInLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgZWxzZVN0YXRlbWVudHM6IFtcbiAgICAgICAgICAgICAgICAgIGBbIC16IFwiXFwke05PVElGSUNBVElPTl9BUk59XCIgXSB8fCAke3B1Ymxpc2hOb3RpZmljYXRpb259YCxcbiAgICAgICAgICAgICAgICAgICdleHBvcnQgTUVTU0FHRT1cIkRlcGxveW1lbnQgd291bGQgbWFrZSBzZWN1cml0eS1pbXBhY3RpbmcgY2hhbmdlcy4gQ2xpY2sgdGhlIGxpbmsgYmVsb3cgdG8gaW5zcGVjdCB0aGVtLCB0aGVuIGNsaWNrIEFwcHJvdmUgaWYgYWxsIGNoYW5nZXMgYXJlIGV4cGVjdGVkLlwiJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgZW52OiB7XG4gICAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IFtcbiAgICAgICAgICAgICdMSU5LJyxcbiAgICAgICAgICAgICdNRVNTQUdFJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICAvLyB0aGlzIGlzIG5lZWRlZCB0byBjaGVjayB0aGUgc3RhdHVzIHRoZSBzdGFja3Mgd2hlbiBkb2luZyBgY2RrIGRpZmZgXG4gICAgdGhpcy5jZGtEaWZmUHJvamVjdC5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0VxdWFscyc6IHtcbiAgICAgICAgICAnaWFtOlJlc291cmNlVGFnL2F3cy1jZGs6Ym9vdHN0cmFwLXJvbGUnOiBbJ2RlcGxveSddLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB0aGlzLnByZUFwcHJvdmVMYW1iZGEuZ3JhbnRJbnZva2UodGhpcy5jZGtEaWZmUHJvamVjdCk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIGlmRWxzZU9wdGlvbnMge1xuICByZWFkb25seSBjb25kaXRpb246IHN0cmluZyxcbiAgcmVhZG9ubHkgdGhlblN0YXRlbWVudHM6IHN0cmluZ1tdLFxuICByZWFkb25seSBlbHNlU3RhdGVtZW50cz86IHN0cmluZ1tdXG59XG5cbmNvbnN0IGlmRWxzZSA9ICh7IGNvbmRpdGlvbiwgdGhlblN0YXRlbWVudHMsIGVsc2VTdGF0ZW1lbnRzIH06IGlmRWxzZU9wdGlvbnMpOiBzdHJpbmcgPT4ge1xuICBsZXQgc3RhdGVtZW50ID0gdGhlblN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmVHJ1ZSkgPT4ge1xuICAgIHJldHVybiBgJHthY2N9ICR7aWZUcnVlfTtgO1xuICB9LCBgaWYgJHtjb25kaXRpb259OyB0aGVuYCk7XG5cbiAgaWYgKGVsc2VTdGF0ZW1lbnRzKSB7XG4gICAgc3RhdGVtZW50ID0gZWxzZVN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmRmFsc2UpID0+IHtcbiAgICAgIHJldHVybiBgJHthY2N9ICR7aWZGYWxzZX07YDtcbiAgICB9LCBgJHtzdGF0ZW1lbnR9IGVsc2VgKTtcbiAgfVxuXG4gIHJldHVybiBgJHtzdGF0ZW1lbnR9IGZpYDtcbn07XG4iXX0=